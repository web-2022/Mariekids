<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>C4 ‚Ä¢ Living Room</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- ‚úÖ PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2563eb">

  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }

    body {
      margin: 0; min-height: 100vh; display: flex; justify-content: center; align-items: center;
      background: linear-gradient(145deg, #dbeafe, #e0f2fe);
      padding: 16px;
    }

    .app {
      background: #ffffff; width: 100%; max-width: 480px; padding: 24px;
      border-radius: 24px; box-shadow: 0 16px 40px rgba(0,0,0,0.12);
      border: 3px solid #2563eb;
    }

    h1 { margin: 0 0 4px 0; text-align: center; font-size: 1.5rem; }
    .subtitle { text-align: center; font-size: 0.9rem; color: #6b7280; margin-bottom: 14px; }

    .status-bar {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 8px; padding: 8px 12px; border-radius: 999px;
      background: #eff6ff; border: 1px solid #bfdbfe; font-size: 0.9rem;
    }

    .xp, .hearts { display: flex; align-items: center; gap: 6px; font-weight: 700; }
    .xp span { color: #16a34a; }
    .hearts span { color: #f97316; }

    .progress-wrapper { margin-bottom: 14px; }
    .progress-label { display: flex; justify-content: space-between; font-size: 0.8rem; color: #6b7280; margin-bottom: 4px; }
    .progress { width: 100%; height: 10px; background: #e5e7eb; border-radius: 999px; overflow: hidden; }
    .progress-inner { height: 100%; width: 0%; border-radius: 999px; background: linear-gradient(90deg, #60a5fa, #2563eb); transition: width 0.2s ease; }

    .card {
      border-radius: 20px; padding: 18px; background: #f9fafb; border: 1px solid #e5e7eb;
      margin-bottom: 16px; transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
    }

    .card.correct { animation: pulse 0.4s ease; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37,99,235,0.3); }
    .card.wrong { animation: shake 0.3s ease; border-color: #ef4444; box-shadow: 0 0 0 3px rgba(239,68,68,0.3); }

    @keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.03)} 100%{transform:scale(1)} }
    @keyframes shake { 0%,100%{transform:translateX(0)} 20%{transform:translateX(-4px)} 40%{transform:translateX(4px)} 60%{transform:translateX(-4px)} 80%{transform:translateX(4px)} }

    .emoji-container { display:flex; justify-content:center; align-items:center; gap:12px; margin-bottom:6px; }
    .emoji { font-size: 5rem; text-align:center; }
    .speak-btn {
      font-size: 1.6rem; cursor: pointer; background: #eff6ff; border-radius: 999px;
      border: 1px solid #bfdbfe; padding: 6px 10px; transition: transform 0.1s ease, background 0.15s ease, border-color 0.15s ease;
    }
    .speak-btn:hover { transform: scale(1.1); background:#dbeafe; border-color:#93c5fd; }

    .word { text-align:center; font-size:1.6rem; font-weight:800; margin-bottom:2px; }
    .translation { text-align:center; font-size:0.95rem; color:#6b7280; margin-bottom:12px; }

    .example-en,.example-es,.question { font-size:0.98rem; margin:6px 0; }
    .label { font-weight:700; }
    .question { margin-top:12px; font-weight:800; color:#111827; }

    .options { display:flex; flex-wrap:wrap; gap:8px; margin-top:12px; }
    .option-btn {
      flex:1; min-width:90px; border-radius:14px; border:1px solid #d1d5db; background:#fff;
      padding:8px 10px; font-size:0.9rem; cursor:pointer; font-weight:700;
      transition: background 0.15s ease, transform 0.1s ease, border 0.1s ease, opacity 0.1s ease;
    }
    .option-btn:hover:not(:disabled) { background:#e0f2fe; transform: translateY(-1px); border-color:#93c5fd; }
    .option-btn:disabled { cursor:default; opacity:0.6; }

    .feedback { margin-top:10px; font-size:0.95rem; text-align:center; min-height:20px; font-weight:800; }
    .feedback.good { color:#16a34a; }
    .feedback.bad { color:#ef4444; }

    .final-message {
      display:none; margin-top:14px; padding:14px; border-radius:16px;
      background: linear-gradient(145deg, #ecfeff, #dbeafe);
      border:2px solid #93c5fd; text-align:center; font-size:1rem; font-weight:900; color:#1e3a8a;
    }
    .final-message span { display:block; margin-top:6px; font-size:0.9rem; font-weight:750; color:#1f2937; }

    .controls { display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; }
    button.main-btn {
      flex:1; border:none; padding:10px 12px; border-radius:999px; font-size:0.95rem; cursor:pointer;
      background: linear-gradient(90deg, #60a5fa, #2563eb);
      color:#fff; font-weight:800; letter-spacing:0.02em;
      transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.15s ease;
      min-width: 140px;
    }
    button.main-btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); filter: brightness(1.05); }
    button.main-btn:disabled { opacity:0.55; cursor:default; }

    /* ‚úÖ banner instalaci√≥n */
    .install-banner {
      display:none; margin: 10px 0 14px 0; padding: 10px 12px;
      border-radius: 16px; border: 1px solid #bfdbfe; background: #eff6ff;
      font-weight: 700; color: #1e3a8a;
    }
    .install-banner .row { display:flex; gap:10px; align-items:center; justify-content:space-between; }
    .install-banner button {
      border:none; border-radius:999px; padding:8px 12px; cursor:pointer;
      background:#2563eb; color:white; font-weight:800;
    }
  </style>
</head>

<body>
  <div class="app">
    <h1>C4 ‚Ä¢ Living Room</h1>
    <p class="subtitle">Mira el emoji, escucha la palabra y elige el objeto correcto en ingl√©s. üõãÔ∏è</p>

    <!-- ‚úÖ Banner de instalaci√≥n (Android/Chrome/Edge suelen mostrarlo) -->
    <div class="install-banner" id="installBanner">
      <div class="row">
        <div>üì≤ ¬øQuieres instalar esta app?</div>
        <button id="installBtn" type="button">Instalar</button>
      </div>
    </div>

    <div class="status-bar">
      <div class="xp">‚úÖ Correctas: <span id="xpValue">0</span></div>
      <div class="hearts">üß† Por mejorar: <span id="heartsValue">0</span></div>
    </div>

    <div class="progress-wrapper">
      <div class="progress-label">
        <span>Progreso de la lecci√≥n</span>
        <span id="progressText">0/10</span>
      </div>
      <div class="progress">
        <div class="progress-inner" id="progressBar"></div>
      </div>
    </div>

    <div class="card" id="lessonCard">
      <div class="emoji-container">
        <div class="emoji" id="emoji" role="img" aria-label="objeto">üõãÔ∏è</div>
        <button class="speak-btn" type="button" aria-label="Pronunciar palabra" onclick="speakWord()">üîä</button>
      </div>

      <div class="word" id="wordEn">sofa</div>
      <div class="translation" id="wordEs">sof√°</div>

      <p class="example-en">
        <span class="label">Ingl√©s:</span>
        <span id="exampleEn">This is a sofa.</span>
      </p>

      <p class="example-es">
        <span class="label">Espa√±ol:</span>
        <span id="exampleEs">Este es un sof√°.</span>
      </p>

      <p class="question" id="question">What is this?</p>

      <div class="options" id="optionsContainer"></div>

      <div class="feedback" id="feedback"></div>

      <div class="final-message" id="finalMessage"></div>
    </div>

    <div class="controls">
      <button class="main-btn" id="nextBtn" type="button" onclick="nextLesson()">Next</button>
      <button class="main-btn" id="restartBtn" type="button" onclick="restartLesson()">Restart</button>
    </div>
  </div>

  <!-- üéµ Sonidos (pon tus mp3 en la misma carpeta) -->
  <audio id="sound-correct" src="correct.mp3" preload="auto"></audio>
  <audio id="sound-wrong" src="wrong.mp3" preload="auto"></audio>
  <audio id="sound-levelup" src="levelup.mp3" preload="auto"></audio>

  <script>
    const itemsData = [
      {
        emoji: "üõãÔ∏è",
        en: "sofa",
        es: "sof√°",
        examplesEn: ["This is a sofa.", "I sit on the sofa.", "The sofa is in the living room."],
        examplesEs: ["Este es un sof√°.", "Yo me siento en el sof√°.", "El sof√° est√° en la sala."],
        questions: ["What is this?", "What is it?", "What can you see in the living room?"]
      },
      {
        emoji: "ü™ë",
        en: "chair",
        es: "silla",
        examplesEn: ["This is a chair.", "I sit on the chair.", "The chair is next to the sofa."],
        examplesEs: ["Esta es una silla.", "Yo me siento en la silla.", "La silla est√° al lado del sof√°."],
        questions: ["What is this?", "Is this a chair or a sofa?", "What can you see?"]
      },
      {
        emoji: "üì∫",
        en: "TV",
        es: "televisi√≥n",
        examplesEn: ["This is a TV.", "I watch TV in the living room.", "The TV is on the wall."],
        examplesEs: ["Esta es una televisi√≥n.", "Veo televisi√≥n en la sala.", "La televisi√≥n est√° en la pared."],
        questions: ["What is this?", "What do you watch?", "Is this a TV?"]
      },
      {
        emoji: "ü™ü",
        en: "window",
        es: "ventana",
        examplesEn: ["This is a window.", "I open the window.", "The window is big."],
        examplesEs: ["Esta es una ventana.", "Yo abro la ventana.", "La ventana es grande."],
        questions: ["What is this?", "What can you open?", "What is in the living room?"]
      },
      {
        emoji: "üö™",
        en: "door",
        es: "puerta",
        examplesEn: ["This is a door.", "I close the door.", "The door is brown."],
        examplesEs: ["Esta es una puerta.", "Yo cierro la puerta.", "La puerta es marr√≥n."],
        questions: ["What is this?", "What do you close?", "Is this a door?"]
      },
      {
        emoji: "üí°",
        en: "lamp",
        es: "l√°mpara",
        examplesEn: ["This is a lamp.", "The lamp is on the table.", "The lamp is bright."],
        examplesEs: ["Esta es una l√°mpara.", "La l√°mpara est√° sobre la mesa.", "La l√°mpara es brillante."],
        questions: ["What is this?", "What gives light?", "Is this a lamp?"]
      },
      {
        emoji: "üß∂",
        en: "rug",
        es: "alfombra",
        examplesEn: ["This is a rug.", "The rug is on the floor.", "The rug is soft."],
        examplesEs: ["Esta es una alfombra.", "La alfombra est√° en el piso.", "La alfombra es suave."],
        questions: ["What is this?", "What is on the floor?", "Is this a rug?"]
      },
      {
        emoji: "üñºÔ∏è",
        en: "picture",
        es: "cuadro",
        examplesEn: ["This is a picture.", "The picture is on the wall.", "I like this picture."],
        examplesEs: ["Este es un cuadro.", "El cuadro est√° en la pared.", "Me gusta este cuadro."],
        questions: ["What is this?", "What is on the wall?", "Is this a picture?"]
      },
      {
        emoji: "üìö",
        en: "bookshelf",
        es: "librero",
        examplesEn: ["This is a bookshelf.", "The books are on the bookshelf.", "The bookshelf is in the living room."],
        examplesEs: ["Este es un librero.", "Los libros est√°n en el librero.", "El librero est√° en la sala."],
        questions: ["What is this?", "Where are the books?", "Is this a bookshelf?"]
      },
      {
        emoji: "üéõÔ∏è",
        en: "remote control",
        es: "control remoto",
        examplesEn: ["This is a remote control.", "I use the remote control for the TV.", "The remote control is on the sofa."],
        examplesEs: ["Este es un control remoto.", "Uso el control remoto para la televisi√≥n.", "El control remoto est√° en el sof√°."],
        questions: ["What is this?", "What do you use for the TV?", "Is this a remote control?"]
      }
    ];

    let currentItem = null;
    let lastItemEn = null;

    let correctCount = 0;
    let wrongCount = 0;
    let answeredCorrectly = false;

    let progress = 0;
    const maxProgress = 10;
    let lessonCompleted = false;

    const correctSpan = document.getElementById("xpValue");
    const wrongSpan = document.getElementById("heartsValue");
    const feedbackEl = document.getElementById("feedback");
    const lessonCard = document.getElementById("lessonCard");
    const progressBar = document.getElementById("progressBar");
    const progressText = document.getElementById("progressText");
    const nextBtn = document.getElementById("nextBtn");

    const soundCorrect = document.getElementById("sound-correct");
    const soundWrong = document.getElementById("sound-wrong");
    const soundLevelup = document.getElementById("sound-levelup");

    function updateProgressBar() {
      const percent = (progress / maxProgress) * 100;
      progressBar.style.width = percent + "%";
      progressText.textContent = `${progress}/${maxProgress}`;
    }

    function randomFromArray(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function getRandomItemNoRepeat() {
      if (itemsData.length <= 1) return itemsData[0];
      let item = null;
      let tries = 0;
      do {
        item = itemsData[Math.floor(Math.random() * itemsData.length)];
        tries++;
      } while (item.en === lastItemEn && tries < 10);
      lastItemEn = item.en;
      return item;
    }

    function generateLesson() {
      const item = getRandomItemNoRepeat();
      const idx = Math.floor(Math.random() * item.examplesEn.length);

      return {
        data: item,
        emoji: item.emoji,
        word: item.en,
        translation: item.es,
        exampleEn: item.examplesEn[idx],
        exampleEs: item.examplesEs[idx],
        question: randomFromArray(item.questions)
      };
    }

    function renderLesson() {
      if (lessonCompleted) return;

      answeredCorrectly = false;

      const lesson = generateLesson();
      currentItem = lesson.data;

      document.getElementById("emoji").textContent = lesson.emoji;
      document.getElementById("emoji").setAttribute("aria-label", lesson.word);

      document.getElementById("wordEn").textContent = lesson.word;
      document.getElementById("wordEs").textContent = lesson.translation;
      document.getElementById("exampleEn").textContent = lesson.exampleEn;
      document.getElementById("exampleEs").textContent = lesson.exampleEs;
      document.getElementById("question").textContent = lesson.question;

      feedbackEl.textContent = "";
      feedbackEl.classList.remove("good", "bad");
      lessonCard.classList.remove("correct", "wrong");

      const finalBox = document.getElementById("finalMessage");
      finalBox.style.display = "none";
      finalBox.innerHTML = "";

      createOptions();
    }

    function createOptions() {
      const container = document.getElementById("optionsContainer");
      container.innerHTML = "";

      const correct = currentItem;
      const others = itemsData.filter(i => i.en !== correct.en);
      shuffleArray(others);

      // 3 opciones
      const options = [correct.en, others[0].en, others[1].en];
      shuffleArray(options);

      options.forEach(optionText => {
        const btn = document.createElement("button");
        btn.textContent = optionText;
        btn.className = "option-btn";
        btn.type = "button";
        btn.onclick = () => checkAnswer(optionText, btn);
        container.appendChild(btn);
      });
    }

    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    function disableAllOptions() {
      document.querySelectorAll(".option-btn").forEach(b => b.disabled = true);
    }

    function playSound(audioElement) {
      if (!audioElement) return;
      audioElement.currentTime = 0;
      audioElement.play().catch(() => {});
    }

    // ‚úÖ Mejor Speech: elige voz en-US si existe
    function speakText(text) {
      if (!("speechSynthesis" in window)) {
        feedbackEl.textContent = "üîá Tu navegador no soporta voz.";
        return;
      }
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = "en-US";
      utter.rate = 0.95;
      utter.pitch = 1.02;

      const voices = window.speechSynthesis.getVoices?.() || [];
      const preferred = voices.find(v => v.lang?.toLowerCase().startsWith("en-us"));
      if (preferred) utter.voice = preferred;

      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
    }

    function speakWord() {
      const word = document.getElementById("wordEn").textContent;
      speakText(word);
    }

    function speakFeedbackCorrect() {
      speakText(randomFromArray(["Great job!", "Awesome!", "Perfect!", "Nice work!"]));
    }

    function speakFeedbackWrong() {
      speakText(randomFromArray(["Not yet, try again.", "Almost, try again.", "Keep trying.", "Don't give up."]));
    }

    function completeLesson() {
      lessonCompleted = true;
      nextBtn.disabled = true;
      disableAllOptions();
      playSound(soundLevelup);

      const finalBox = document.getElementById("finalMessage");
      finalBox.innerHTML = `
        üéâ ¬°Felicitaciones!<br>
        Hiciste <strong>${correctCount}</strong> correctas de <strong>${maxProgress}</strong>.
        <span>¬°Excelente trabajo! üí™‚ú®<br>Reinicia para practicar otra vez üöÄ</span>
      `;
      finalBox.style.display = "block";

      feedbackEl.textContent = "‚úÖ Lesson complete! Keep practicing.";
      feedbackEl.classList.add("good");
    }

    function checkAnswer(answer, clickedBtn) {
      if (!currentItem || lessonCompleted) return;
      if (answeredCorrectly) return;

      if (answer === currentItem.en) {
        answeredCorrectly = true;
        correctCount++;
        correctSpan.textContent = correctCount;

        if (progress < maxProgress) {
          progress += 1;
          updateProgressBar();
        }

        feedbackEl.textContent = randomFromArray(["‚úÖ Great job!", "‚úÖ Awesome!", "‚úÖ Perfect!", "‚úÖ Nice!"]);
        feedbackEl.classList.remove("bad");
        feedbackEl.classList.add("good");

        playSound(soundCorrect);
        speakFeedbackCorrect();

        lessonCard.classList.remove("wrong");
        lessonCard.classList.add("correct");

        disableAllOptions();

        if (correctCount > 0 && correctCount % 5 === 0) {
          playSound(soundLevelup);
        }

        if (progress >= maxProgress) {
          completeLesson();
        }

      } else {
        wrongCount++;
        wrongSpan.textContent = wrongCount;

        feedbackEl.textContent = "‚ùå Not yet. Try again.";
        feedbackEl.classList.remove("good");
        feedbackEl.classList.add("bad");

        playSound(soundWrong);
        speakFeedbackWrong();

        lessonCard.classList.remove("correct");
        lessonCard.classList.add("wrong");

        if (clickedBtn) clickedBtn.disabled = true;
      }
    }

    function nextLesson() {
      if (lessonCompleted) return;
      renderLesson();
    }

    function restartLesson() {
      lessonCompleted = false;
      nextBtn.disabled = false;

      correctCount = 0;
      wrongCount = 0;
      progress = 0;
      answeredCorrectly = false;
      lastItemEn = null;

      correctSpan.textContent = "0";
      wrongSpan.textContent = "0";

      feedbackEl.textContent = "";
      feedbackEl.classList.remove("good", "bad");

      updateProgressBar();
      renderLesson();
    }

    // Inicializar
    updateProgressBar();
    renderLesson();

    // ---- ‚úÖ PWA Install prompt (Android/Chrome) ----
    let deferredPrompt = null;
    const banner = document.getElementById("installBanner");
    const installBtn = document.getElementById("installBtn");

    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
      banner.style.display = "block";
    });

    installBtn?.addEventListener("click", async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      banner.style.display = "none";
    });

    // iOS no lanza beforeinstallprompt: ah√≠ se instala con Compartir ‚Üí Agregar a inicio
  </script>

  <!-- ‚úÖ registrar service worker -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./service-worker.js").catch(() => {});
      });
    }
  </script>
</body>
</html>
