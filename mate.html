<!DOCTYPE html>
<html lang="es">

    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>C3 ‚Ä¢ Ecuaciones de primer grado (paso a paso)</title>

        <!-- PWA -->
        <link rel="manifest" href="manifest.json">
        <meta name="theme-color" content="#1976d2">

        <style>
            * {
                box-sizing: border-box;
                font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            }

            body {
                margin: 0;
                min-height: 100dvh;
                /* mejor que 100vh en celular */
                display: flex;
                justify-content: center;
                align-items: flex-start;
                /* en vez de center */
                background: linear-gradient(145deg, #dbeafe, #e0f2fe);
                padding: 12px;
                overflow-y: auto;
                /* permite scroll si falta espacio */
            }

            /* NAV */
            .nav {
                display: flex;
                gap: 10px;
                background: #eff6ff;
                border: 1px solid #bfdbfe;
                padding: 10px;
                border-radius: 18px;
                margin-bottom: 14px;
                flex-wrap: wrap;
                justify-content: center;
            }

            .nav-btn {
                border: 1px solid #bfdbfe;
                background: #ffffff;
                border-radius: 999px;
                padding: 8px 12px;
                cursor: pointer;
                font-weight: 700;
                font-size: 0.95rem;
                transition: transform 0.1s ease, background 0.15s ease, border-color 0.15s ease, opacity 0.1s ease;
                min-width: 120px;
            }

            .nav-btn:hover {
                transform: translateY(-1px);
                background: #e0f2fe;
                border-color: #93c5fd;
            }

            .nav-btn.active {
                background: linear-gradient(90deg, #60a5fa, #2563eb);
                color: #fff;
                border-color: transparent;
            }

            /* üåü Encabezado infantil */
            .brand-header-kids {
                position: relative;
                overflow: hidden;
                padding: 14px 14px 12px;
                border-radius: 22px;
                margin-bottom: 12px;
                background: linear-gradient(135deg, #93c5fd, #60a5fa, #2563eb);
                border: 2px solid rgba(255, 255, 255, .65);
                box-shadow: 0 14px 28px rgba(37, 99, 235, .25);
                color: #fff;
            }

            .brand-row {
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .kids-badge {
                width: 52px;
                height: 52px;
                border-radius: 18px;
                display: grid;
                place-items: center;
                font-size: 1.55rem;
                background: rgba(255, 255, 255, .22);
                border: 1px solid rgba(255, 255, 255, .35);
                box-shadow: inset 0 1px 0 rgba(255, 255, 255, .35);
            }

            .kids-title {
                font-weight: 950;
                font-size: 1.55rem;
                letter-spacing: .02em;
                line-height: 1.05;
                text-shadow: 0 2px 0 rgba(0, 0, 0, .12);
            }

            .kids-subtitle {
                margin-top: 4px;
                font-size: .9rem;
                font-weight: 750;
                opacity: .95;
                display: flex;
                align-items: center;
                gap: 8px;
                flex-wrap: wrap;
            }

            .kids-pill {
                background: rgba(255, 255, 255, .22);
                border: 1px solid rgba(255, 255, 255, .35);
                padding: 4px 10px;
                border-radius: 999px;
                font-size: .82rem;
                font-weight: 850;
            }

            .star {
                position: absolute;
                opacity: .9;
                filter: drop-shadow(0 2px 0 rgba(0, 0, 0, .12));
                animation: twinkle 2.8s ease-in-out infinite;
                pointer-events: none;
            }

            .star.s1 {
                top: 8px;
                right: 18px;
                font-size: 1.15rem;
                animation-delay: 0s;
            }

            .star.s2 {
                top: 40px;
                right: 60px;
                font-size: .95rem;
                animation-delay: .6s;
            }

            .star.s3 {
                bottom: 12px;
                right: 26px;
                font-size: 1.25rem;
                animation-delay: 1.1s;
            }

            .bubble {
                position: absolute;
                width: 64px;
                height: 64px;
                border-radius: 999px;
                background: rgba(255, 255, 255, .22);
                border: 1px solid rgba(255, 255, 255, .28);
                box-shadow: inset 0 2px 0 rgba(255, 255, 255, .45);
                backdrop-filter: blur(2px);
                pointer-events: none;
                animation: floaty 6s ease-in-out infinite;
            }

            .b1 {
                left: -16px;
                top: -18px;
                animation-delay: 0s;
                transform: rotate(5deg);
            }

            .b2 {
                left: 40px;
                bottom: -22px;
                width: 52px;
                height: 52px;
                animation-delay: .8s;
            }

            .b3 {
                right: -22px;
                bottom: -26px;
                width: 76px;
                height: 76px;
                animation-delay: 1.3s;
            }

            @keyframes floaty {

                0%,
                100% {
                    transform: translateY(0) scale(1);
                }

                50% {
                    transform: translateY(-8px) scale(1.03);
                }
            }

            @keyframes twinkle {

                0%,
                100% {
                    transform: scale(1) rotate(0deg);
                    opacity: .9;
                }

                50% {
                    transform: scale(1.12) rotate(6deg);
                    opacity: 1;
                }
            }


            .app {
                background: #fff;
                width: 100%;
                max-width: 520px;
                padding: 24px;
                border-radius: 24px;
                box-shadow: 0 16px 40px rgba(0, 0, 0, 0.12);
                border: 3px solid #2563eb;
            }

            h1 {
                margin: 0 0 4px 0;
                text-align: center;
                font-size: 1.5rem;
            }

            .subtitle {
                text-align: center;
                font-size: 0.9rem;
                color: #6b7280;
                margin-bottom: 14px;
            }

            .status-bar {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
                padding: 8px 12px;
                border-radius: 999px;
                background: #eff6ff;
                border: 1px solid #bfdbfe;
                font-size: 0.9rem;
            }

            .stat {
                display: flex;
                align-items: center;
                gap: 6px;
                font-weight: 800;
            }

            .stat .value {
                font-weight: 1000;
            }

            .stat.correct .value {
                color: #16a34a;
            }

            .stat.improve .value {
                color: #f97316;
            }

            .progress-wrapper {
                margin-bottom: 14px;
            }

            .progress-label {
                display: flex;
                justify-content: space-between;
                font-size: 0.8rem;
                color: #6b7280;
                margin-bottom: 4px;
            }

            .progress {
                width: 100%;
                height: 10px;
                background: #e5e7eb;
                border-radius: 999px;
                overflow: hidden;
            }

            .progress-inner {
                height: 100%;
                width: 0%;
                border-radius: 999px;
                background: linear-gradient(90deg, #60a5fa, #2563eb);
                transition: width 0.2s ease;
            }

            .card {
                border-radius: 20px;
                padding: 5px;
                background: #f9fafb;
                border: 1px solid #e5e7eb;
                margin-bottom: 1px;
                transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
            }

            .card.correct {
                animation: pulse 0.4s ease;
                border-color: #2563eb;
                box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.3);
            }

            .card.wrong {
                animation: shake 0.3s ease;
                border-color: #ef4444;
                box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.3);
            }

            @keyframes pulse {
                0% {
                    transform: scale(1)
                }

                50% {
                    transform: scale(1.03)
                }

                100% {
                    transform: scale(1)
                }
            }

            @keyframes shake {

                0%,
                100% {
                    transform: translateX(0)
                }

                20% {
                    transform: translateX(-4px)
                }

                40% {
                    transform: translateX(4px)
                }

                60% {
                    transform: translateX(-4px)
                }

                80% {
                    transform: translateX(4px)
                }
            }

            .emoji-container {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 12px;
                margin-bottom: 6px;
            }

            .emoji {
                font-size: 5rem;
                text-align: center;
            }

            .speak-btn {
                font-size: 1.6rem;
                cursor: pointer;
                background: #eff6ff;
                border-radius: 999px;
                border: 1px solid #bfdbfe;
                padding: 6px 10px;
                transition: transform 0.1s ease, background 0.15s ease, border-color 0.15s ease;
            }

            .speak-btn:hover {
                transform: scale(1.1);
                background: #dbeafe;
                border-color: #93c5fd;
            }

            .title-line {
                text-align: center;
                font-size: 1.5rem;
                font-weight: 1000;
                margin: 2px 0 10px;
            }

            .steps {
                background: #ffffff;
                border: 1px solid #e5e7eb;
                border-radius: 16px;
                padding: 12px;
                margin-top: 10px;
            }

            .steps .steps-title {
                font-weight: 1000;
                color: #111827;
                margin: 0 0 8px;
                font-size: 0.95rem;
                text-align: center;
            }

            .step-line {
                font-size: 1.02rem;
                font-weight: 900;
                padding: 8px 10px;
                border-radius: 12px;
                background: #f8fafc;
                border: 1px solid #e5e7eb;
                margin: 8px 0;
                text-align: center;
            }

            .step-line.final {
                border-color: #bfdbfe;
                background: #eff6ff;
            }

            .question {
                margin-top: 12px;
                font-weight: 1000;
                color: #111827;
                text-align: center;
            }

            .hint {
                text-align: center;
                color: #6b7280;
                margin: 6px 0 0;
                font-size: 0.9rem;
            }

            .options {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
                margin-top: 12px;
            }

            .option-btn {
                border-radius: 14px;
                border: 1px solid #d1d5db;
                background: #fff;
                padding: 10px 12px;
                font-size: 1rem;
                cursor: pointer;
                font-weight: 900;
                text-align: center;
                transition: background 0.15s ease, transform 0.1s ease, border 0.1s ease, opacity 0.1s ease;
            }

            .option-btn:hover:not(:disabled) {
                background: #e0f2fe;
                transform: translateY(-1px);
                border-color: #93c5fd;
            }

            .option-btn:disabled {
                cursor: default;
                opacity: 0.6;
            }

            .feedback {
                margin-top: 1px;
                font-size: 0.98rem;
                text-align: center;
                min-height: 1px;
                font-weight: 1000;
            }

            .feedback.good {
                color: #16a34a;
            }

            .feedback.bad {
                color: #ef4444;
            }

            .controls {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                margin-top: 10px;
            }

            button.main-btn {
                flex: 1;
                border: none;
                padding: 10px 12px;
                border-radius: 999px;
                font-size: 0.95rem;
                cursor: pointer;
                background: linear-gradient(90deg, #60a5fa, #2563eb);
                color: #fff;
                font-weight: 1000;
                letter-spacing: 0.02em;
                transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.15s ease;
                min-width: 140px;
            }

            button.main-btn:hover {
                transform: translateY(-1px);
                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
                filter: brightness(1.05);
            }

            button.main-btn.secondary {
                background: #e5e7eb;
                color: #111827;
                box-shadow: none;
            }

            /* Modal final */
            .overlay {
                position: fixed;
                inset: 0;
                background: rgba(15, 23, 42, 0.55);
                display: none;
                align-items: center;
                justify-content: center;
                padding: 18px;
            }

            .overlay.show {
                display: flex;
            }

            .modal {
                width: 100%;
                max-width: 520px;
                background: #fff;
                border-radius: 22px;
                padding: 18px;
                border: 2px solid #bfdbfe;
                box-shadow: 0 18px 50px rgba(0, 0, 0, 0.25);
                text-align: center;
            }

            .modal .title {
                font-size: 1.35rem;
                font-weight: 1100;
                margin: 6px 0 8px;
            }

            .modal .score {
                font-size: 1.1rem;
                font-weight: 1100;
                margin: 0 0 10px;
            }

            .modal .msg {
                color: #374151;
                margin: 0 0 12px;
                line-height: 1.35;
                font-weight: 850;
                white-space: pre-line;
            }

            .mistakes {
                text-align: left;
                background: #f8fafc;
                border: 1px solid #e5e7eb;
                border-radius: 16px;
                padding: 12px;
                margin: 12px 0;
            }

            .mistakes h3 {
                margin: 0 0 8px;
                font-size: 1rem;
            }

            .mistakes ul {
                margin: 0;
                padding-left: 18px;
                color: #374151;
            }

            @media (max-width: 480px) {
                body {
                    padding: 8px;
                }

                .app {
                    padding: 14px;
                }

                .emoji {
                    font-size: 4.2rem;
                }

                .card {
                    padding: 7px;
                    margin-bottom: 6px;
                }

                .nav {
                    padding: 8px;
                    margin-bottom: 10px;
                }
            }
        </style>
    </head>

    <body>
        <div class="app">

            <!-- Men√∫ de navegaci√≥n -->
            <div class="nav" role="navigation" aria-label="Cursos">
                <button class="nav-btn" onclick="location.href='index.html'">üá∫üá∏ Ingl√©s</button>
                <button class="nav-btn" onclick="location.href='ajedrez.html'">‚ôüÔ∏è Ajedrez</button>
                <button class="nav-btn active" onclick="location.href='mate.html'">‚ûó Matem√°ticas</button>
            </div>

            <!-- üåü Encabezado infantil: Marie Kids -->
            <div class="brand-header-kids" aria-label="Marie Kids">
                <div class="bubble b1"></div>
                <div class="bubble b2"></div>
                <div class="bubble b3"></div>

                <div class="star s1">‚≠ê</div>
                <div class="star s2">‚ú®</div>
                <div class="star s3">üåü</div>

                <div class="brand-row">
                    <div class="kids-badge" aria-hidden="true">‚úñÔ∏è</div>
                    <div>
                        <div class="kids-title">Marie Kids</div>
                        <div class="kids-subtitle">
                            Matem√°ticas paso a paso...
                            <span class="kids-pill">Observa</span>
                            <span class="kids-pill">üëâ Practica</span>
                        </div>
                    </div>
                </div>
            </div>


            <h1>Ecuaciones de primer grado</h1>
            <p class="subtitle">Mira el paso a paso y luego elige el valor correcto de <b>x</b>. üß†</p>

            <div class="status-bar">
                <div class="stat correct">‚úÖ Correctas: <span class="value" id="correctValue">0</span></div>
                <div class="stat improve">üß† Por mejorar: <span class="value" id="improveValue">0</span></div>
            </div>

            <div class="progress-wrapper">
                <div class="progress-label">
                    <span>Progreso</span>
                    <span id="progressText">0/10</span>
                </div>
                <div class="progress">
                    <div class="progress-inner" id="progressBar"></div>
                </div>
            </div>

            <div class="card" id="lessonCard">
                <div class="emoji-container">
                    <div class="emoji" id="emoji"></div>
                    <button class="speak-btn" onclick="speakCurrent()" aria-label="Escuchar">üîä</button>
                </div>

                <div class="title-line" id="equationTitle">x + 8 = 10</div>

                <div class="steps" aria-label="Soluci√≥n paso a paso">
                    <div class="steps-title">Soluci√≥n paso a paso</div>
                    <div id="stepsContainer"></div>
                </div>

                <div class="question">¬øCu√°l es el valor de <b>x</b>?</div>
                <p class="hint" id="hint">Tip: lo que suma, pasa restando; lo que resta, pasa sumando.</p>

                <div class="options" id="optionsContainer"></div>
                <div class="feedback" id="feedback"></div>
            </div>

            <div class="controls">
                <button class="main-btn" onclick="nextLesson()">Next</button>
                <button class="main-btn" onclick="shareApp()">üì§ Compartir app</button>
            </div>
        </div>

        <!-- Sonidos (pon los mp3 en la misma carpeta) -->
        <audio id="sound-correct" src="correct.mp3" preload="auto"></audio>
        <audio id="sound-wrong" src="wrong.mp3" preload="auto"></audio>
        <audio id="sound-levelup" src="levelup.mp3" preload="auto"></audio>

        <!-- Modal final -->
        <div class="overlay" id="overlay">
            <div class="modal">
                <div class="title">üéâ ¬°Felicitaciones!</div>
                <div class="score" id="finalScore">Hiciste 0 correctas de 0</div>
                <p class="msg" id="finalMsg">¬°Excelente trabajo! üí™‚ú®</p>

                <div class="mistakes" id="mistakesBox" style="display:none;">
                    <h3>Practica donde te equivocaste üëá</h3>
                    <ul id="mistakesList"></ul>
                </div>

                <div class="controls" style="margin-top:10px;">
                    <button class="main-btn secondary" onclick="closeFinal()">Cerrar</button>
                    <button class="main-btn" id="practiceMistakesBtn" onclick="practiceMistakes()"
                        style="display:none;">
                        Practicar donde me equivoqu√©
                    </button>
                </div>
            </div>
        </div>

        <script>
            /***************
             * Sonidos
             ***************/
            const soundCorrectEl = document.getElementById("sound-correct");
            const soundWrongEl = document.getElementById("sound-wrong");
            const soundLevelupEl = document.getElementById("sound-levelup");

            function playSound(audioElement) {
                if (!audioElement) return;
                audioElement.currentTime = 0;
                audioElement.play().catch(() => { });
            }
            function soundCorrect() { playSound(soundCorrectEl); }
            function soundWrong() { playSound(soundWrongEl); }
            function soundLevelUp() { playSound(soundLevelupEl); }

            /***************
             * Datos: ecuaci√≥n + pasos ya listos
             ***************/
            const pool = [
                {
                    id: 1,
                    eq: "x + 8 = 10",
                    x: 2,
                    steps: ["x = 10 - 8", "x = 2"]
                },
                {
                    id: 2,
                    eq: "2x - 5 = 7",
                    x: 6,
                    steps: ["2x = 7 + 5", "2x = 12", "x = 12 / 2", "x = 6"]
                },
                {
                    id: 3,
                    eq: "3x + 4 = 19",
                    x: 5,
                    steps: ["3x = 19 - 4", "3x = 15", "x = 15 / 3", "x = 5"]
                },
                {
                    id: 4,
                    eq: "x/2 + 7 = 10",
                    x: 6,
                    steps: ["x/2 = 10 - 7", "x/2 = 3", "x = 3 √ó 2", "x = 6"]
                },
                {
                    id: 5,
                    eq: "5x = 25",
                    x: 5,
                    steps: ["x = 25 / 5", "x = 5"]
                },
                {
                    id: 6,
                    eq: "4x + 1 = 21",
                    x: 5,
                    steps: ["4x = 21 - 1", "4x = 20", "x = 20 / 4", "x = 5"]
                },
                {
                    id: 7,
                    eq: "7x + 2 = 30",
                    x: 4,
                    steps: ["7x = 30 - 2", "7x = 28", "x = 28 / 7", "x = 4"]
                },
                {
                    id: 8,
                    eq: "x + 5 = 2x - 1",
                    x: 6,
                    steps: ["x - 2x = -1 - 5", "-x = -6", "x = 6"]
                },
                {
                    id: 9,
                    eq: "3(x - 2) = 12",
                    x: 6,
                    steps: ["x - 2 = 12 / 3", "x - 2 = 4", "x = 4 + 2", "x = 6"]
                },
                {
                    id: 10,
                    eq: "2(x + 3) = 14",
                    x: 4,
                    steps: ["x + 3 = 14 / 2", "x + 3 = 7", "x = 7 - 3", "x = 4"]
                },
                {
                    id: 11,
                    eq: "9x - 18 = 45",
                    x: 7,
                    steps: ["9x = 45 + 18", "9x = 63", "x = 63 / 9", "x = 7"]
                },
                {
                    id: 12,
                    eq: "6x - 12 = 0",
                    x: 2,
                    steps: ["6x = 0 + 12", "6x = 12", "x = 12 / 6", "x = 2"]
                }
            ];

            const TOTAL = 10;

            // Estado
            let lessonQueue = [];
            let currentIndex = 0;
            let current = null;

            let correctCount = 0;
            let improveCount = 0;

            // Control para no contar doble
            let answeredCorrectly = false;

            // Para practicar donde fall√≥
            const mistakesMap = new Map(); // id -> {eq,x,steps,wrongTries}
            let isMistakesMode = false;

            // UI refs
            const correctSpan = document.getElementById("correctValue");
            const improveSpan = document.getElementById("improveValue");
            const progressBar = document.getElementById("progressBar");
            const progressText = document.getElementById("progressText");
            const lessonCard = document.getElementById("lessonCard");
            const feedbackEl = document.getElementById("feedback");
            const stepsContainer = document.getElementById("stepsContainer");
            const equationTitle = document.getElementById("equationTitle");

            function shuffleArray(arr) {
                for (let i = arr.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [arr[i], arr[j]] = [arr[j], arr[i]];
                }
            }

            function pickLessonQueue() {
                const copy = pool.map(p => ({ ...p }));
                shuffleArray(copy);
                lessonQueue = copy.slice(0, TOTAL);
                currentIndex = 0;
            }

            function updateProgress() {
                const done = currentIndex;
                const max = lessonQueue.length;
                const percent = max === 0 ? 0 : (done / max) * 100;
                progressBar.style.width = percent + "%";
                progressText.textContent = `${done}/${max}`;
            }

            function renderSteps(steps) {
                stepsContainer.innerHTML = "";
                steps.forEach((s, idx) => {
                    const div = document.createElement("div");
                    div.className = "step-line" + (idx === steps.length - 1 ? " final" : "");
                    div.textContent = s;
                    stepsContainer.appendChild(div);
                });
            }

            function renderCurrent() {
                if (currentIndex >= lessonQueue.length) {
                    showFinal();
                    return;
                }
                current = lessonQueue[currentIndex];
                answeredCorrectly = false;

                updateProgress();

                equationTitle.textContent = current.eq;
                renderSteps(current.steps);

                feedbackEl.textContent = "";
                feedbackEl.classList.remove("good", "bad");
                lessonCard.classList.remove("correct", "wrong");

                createOptions();
            }

            function createOptions() {
                const container = document.getElementById("optionsContainer");
                container.innerHTML = "";

                const correct = current.x;
                const candidates = new Set([correct]);

                const deltas = [-3, -2, -1, 1, 2, 3, 4, -4, 5, -5];
                shuffleArray(deltas);
                for (const d of deltas) {
                    if (candidates.size >= 3) break;
                    candidates.add(correct + d);
                }

                const options = Array.from(candidates).slice(0, 3);
                shuffleArray(options);

                options.forEach(v => {
                    const btn = document.createElement("button");
                    btn.className = "option-btn";
                    btn.textContent = `x = ${v}`;
                    btn.onclick = () => checkAnswer(v, btn);
                    container.appendChild(btn);
                });
            }

            function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

            function speakText(text) {
                if (!("speechSynthesis" in window)) return;
                const utter = new SpeechSynthesisUtterance(text);
                utter.lang = "en-US";
                utter.rate = 0.95;
                utter.pitch = 1.02;
                window.speechSynthesis.cancel();
                window.speechSynthesis.speak(utter);
            }
            function speakFeedbackCorrect() { speakText(pick(["Great job!", "Awesome!", "Perfect!", "Nice work!"])); }
            function speakFeedbackWrong() { speakText(pick(["Not yet, try again.", "Almost, try again.", "Keep trying.", "Don't give up."])); }

            function checkAnswer(value, clickedBtn) {
                if (!current) return;
                if (answeredCorrectly) return;

                if (value === current.x) {
                    answeredCorrectly = true;

                    correctCount++;
                    correctSpan.textContent = correctCount;

                    feedbackEl.textContent = pick(["‚úÖ Perfect!", "‚úÖ Good job!", "‚úÖ Awesome!", "‚úÖ Nice!"]);
                    feedbackEl.classList.remove("bad");
                    feedbackEl.classList.add("good");

                    lessonCard.classList.remove("wrong");
                    lessonCard.classList.add("correct");

                    soundCorrect();
                    speakFeedbackCorrect();

                    // Deshabilitar todas para evitar doble conteo
                    document.querySelectorAll(".option-btn").forEach(b => b.disabled = true);

                    if (correctCount > 0 && correctCount % 5 === 0) soundLevelUp();

                } else {
                    improveCount++;
                    improveSpan.textContent = improveCount;

                    feedbackEl.textContent = "‚ùå Not yet. Try again.";
                    feedbackEl.classList.remove("good");
                    feedbackEl.classList.add("bad");

                    lessonCard.classList.remove("correct");
                    lessonCard.classList.add("wrong");

                    soundWrong();
                    speakFeedbackWrong();

                    // Guardar ‚Äúpor mejorar‚Äù
                    if (!mistakesMap.has(current.id)) {
                        mistakesMap.set(current.id, { id: current.id, eq: current.eq, x: current.x, steps: current.steps, wrongTries: 1 });
                    } else {
                        mistakesMap.get(current.id).wrongTries += 1;
                    }

                    // Deshabilitar solo el bot√≥n incorrecto
                    if (clickedBtn) clickedBtn.disabled = true;
                }
            }

            function nextLesson() {
                // Solo avanzar si ya acert√≥
                if (!answeredCorrectly) {
                    feedbackEl.textContent = "üëâ Primero acierta para pasar al siguiente.";
                    feedbackEl.classList.remove("good");
                    feedbackEl.classList.add("bad");
                    lessonCard.classList.add("wrong");
                    soundWrong();
                    return;
                }
                currentIndex++;
                renderCurrent();
            }

            function resetLesson() {
                isMistakesMode = false;
                mistakesMap.clear();

                correctCount = 0; improveCount = 0;
                correctSpan.textContent = "0";
                improveSpan.textContent = "0";

                pickLessonQueue();
                updateProgress();
                renderCurrent();
            }

            function speakCurrent() {
                const text = `Solve for x. ${equationTitle.textContent}`;
                if (!("speechSynthesis" in window)) return;
                const utter = new SpeechSynthesisUtterance(text);
                utter.lang = "en-US";
                utter.rate = 0.95;
                window.speechSynthesis.cancel();
                window.speechSynthesis.speak(utter);
            }

            /***************
             * FINAL + practicar errores
             ***************/
            const overlay = document.getElementById("overlay");
            const finalScore = document.getElementById("finalScore");
            const finalMsg = document.getElementById("finalMsg");
            const mistakesBox = document.getElementById("mistakesBox");
            const mistakesList = document.getElementById("mistakesList");
            const practiceMistakesBtn = document.getElementById("practiceMistakesBtn");

            function showFinal() {
                updateProgress();
                soundLevelUp();

                const total = lessonQueue.length;
                finalScore.textContent = `Hiciste ${correctCount} correctas de ${total}`;
                finalMsg.textContent =
                    `¬°Excelente trabajo! üí™‚ú®
Sigue practicando, cada intento te hace mejor üöÄ`;

                const mistakes = Array.from(mistakesMap.values());
                if (mistakes.length > 0) {
                    mistakesBox.style.display = "block";
                    practiceMistakesBtn.style.display = "inline-flex";
                    mistakesList.innerHTML = "";
                    mistakes
                        .sort((a, b) => b.wrongTries - a.wrongTries)
                        .forEach(m => {
                            const li = document.createElement("li");
                            li.textContent = `${m.eq}  (respuesta: x = ${m.x})`;
                            mistakesList.appendChild(li);
                        });
                } else {
                    mistakesBox.style.display = "none";
                    practiceMistakesBtn.style.display = "none";
                }

                overlay.classList.add("show");
            }

            function closeFinal() { overlay.classList.remove("show"); }

            function practiceMistakes() {
                const mistakes = Array.from(mistakesMap.values());
                if (mistakes.length === 0) return;

                isMistakesMode = true;
                lessonQueue = mistakes.map(m => ({ id: m.id, eq: m.eq, x: m.x, steps: m.steps }));
                currentIndex = 0;

                overlay.classList.remove("show");
                updateProgress();
                renderCurrent();
            }

            // Inicializar
            resetLesson();
        </script>

        <script>
            // Registrar Service Worker (PWA)
            if ("serviceWorker" in navigator) {
                window.addEventListener("load", () => {
                    navigator.serviceWorker.register("./service-worker.js").catch(() => { });
                });
            }
        </script>

        <script>
            function shareApp() {
                const shareData = {
                    title: "Mini Cursos",
                    text: "üìö Aprende ingl√©s, ajedrez y matem√°ticas con esta app educativa",
                    url: window.location.href
                };

                if (navigator.share) {
                    navigator.share(shareData)
                        .catch(() => { });
                } else {
                    // Fallback para navegadores que no soportan Web Share
                    navigator.clipboard.writeText(shareData.url);
                    alert("üîó Link copiado para compartir");
                }
            }
        </script>
    </body>

</html>
