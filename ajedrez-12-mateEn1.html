<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Marie Kids ‚Ä¢ Ajedrez ‚Ä¢ Mate en 1 (Arrastra)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1976d2">

  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    /* =========================
       ‚úÖ RESPONSIVE BOOST
       ========================= */
    :root {
      --app-max: 540px;
      --app-pad: clamp(14px, 3.2vw, 24px);
      --radius: clamp(18px, 4vw, 24px);

      --board-max: min(92vw, 420px);
      --coords-gap: clamp(16px, 4vw, 22px);

      --h1: clamp(1.2rem, 3.2vw, 1.55rem);
      --sub: clamp(0.85rem, 2.4vw, 0.95rem);
      --btn: clamp(0.9rem, 2.6vw, 0.95rem);
      --piece: clamp(2.0rem, 8vw, 2.6rem);
    }

    html {
      -webkit-text-size-adjust: 100%;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: linear-gradient(145deg, #dbeafe, #e0f2fe);
      padding:
        calc(14px + env(safe-area-inset-top)) calc(14px + env(safe-area-inset-right)) calc(14px + env(safe-area-inset-bottom)) calc(14px + env(safe-area-inset-left));
    }

    .app {
      background: #fff;
      width: 100%;
      max-width: var(--app-max);
      padding: var(--app-pad);
      border-radius: var(--radius);
      box-shadow: 0 16px 40px rgba(0, 0, 0, .12);
      border: 3px solid #2563eb;
    }

    /* ======= MEN√ö ======= */
    .nav {
      display: flex;
      gap: 10px;
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      padding: 10px;
      border-radius: 18px;
      margin-bottom: 14px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .nav-btn {
      display: inline-block;
      text-decoration: none;
      border: 1px solid #bfdbfe;
      background: #fff;
      border-radius: 999px;
      padding: 8px 12px;
      cursor: pointer;
      font-weight: 800;
      font-size: var(--btn);
      transition: transform .1s ease, background .15s ease, border-color .15s ease, opacity .1s ease;
      min-width: clamp(110px, 30vw, 160px);
      text-align: center;
      color: #111827;
    }

    .nav-btn:hover {
      transform: translateY(-1px);
      background: #e0f2fe;
      border-color: #93c5fd;
    }

    .nav-btn.active {
      background: linear-gradient(90deg, #60a5fa, #2563eb);
      color: #fff;
      border-color: transparent;
    }

    /* üåü Encabezado infantil */
    .brand-header-kids {
      position: relative;
      overflow: hidden;
      padding: 14px 14px 12px;
      border-radius: 22px;
      margin-bottom: 12px;
      background: linear-gradient(135deg, #93c5fd, #60a5fa, #2563eb);
      border: 2px solid rgba(255, 255, 255, .65);
      box-shadow: 0 14px 28px rgba(37, 99, 235, .25);
      color: #fff;
    }

    /* ‚úÖ NUEVO: hacerlo clickeable (ir a index.html) */
    .brand-header-kids.clickable {
      cursor: pointer;
      user-select: none;
      transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
    }

    .brand-header-kids.clickable:hover {
      transform: translateY(-1px);
      filter: brightness(1.02);
      box-shadow: 0 18px 34px rgba(37, 99, 235, .28);
    }

    .brand-header-kids.clickable:active {
      transform: translateY(0px) scale(0.995);
    }

    /* ‚úÖ para que el click funcione aunque toques estrellas/burbujas */
    .brand-header-kids .bubble,
    .brand-header-kids .star {
      pointer-events: none;
    }

    .brand-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .kids-badge {
      width: 52px;
      height: 52px;
      border-radius: 18px;
      display: grid;
      place-items: center;
      font-size: 1.55rem;
      background: rgba(255, 255, 255, .22);
      border: 1px solid rgba(255, 255, 255, .35);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, .35);
    }

    .kids-title {
      font-weight: 950;
      font-size: 1.55rem;
      letter-spacing: .02em;
      line-height: 1.05;
      text-shadow: 0 2px 0 rgba(0, 0, 0, .12);
    }

    .kids-subtitle {
      margin-top: 4px;
      font-size: .9rem;
      font-weight: 750;
      opacity: .95;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .kids-pill {
      background: rgba(255, 255, 255, .22);
      border: 1px solid rgba(255, 255, 255, .35);
      padding: 4px 10px;
      border-radius: 999px;
      font-size: .82rem;
      font-weight: 850;
    }

    .star {
      position: absolute;
      opacity: .9;
      filter: drop-shadow(0 2px 0 rgba(0, 0, 0, .12));
      animation: twinkle 2.8s ease-in-out infinite;
      pointer-events: none;
    }

    .star.s1 {
      top: 8px;
      right: 18px;
      font-size: 1.15rem;
      animation-delay: 0s;
    }

    .star.s2 {
      top: 40px;
      right: 60px;
      font-size: .95rem;
      animation-delay: .6s;
    }

    .star.s3 {
      bottom: 12px;
      right: 26px;
      font-size: 1.25rem;
      animation-delay: 1.1s;
    }

    .bubble {
      position: absolute;
      width: 64px;
      height: 64px;
      border-radius: 999px;
      background: rgba(255, 255, 255, .22);
      border: 1px solid rgba(255, 255, 255, .28);
      box-shadow: inset 0 2px 0 rgba(255, 255, 255, .45);
      backdrop-filter: blur(2px);
      pointer-events: none;
      animation: floaty 6s ease-in-out infinite;
    }

    .b1 {
      left: -16px;
      top: -18px;
      animation-delay: 0s;
      transform: rotate(5deg);
    }

    .b2 {
      left: 40px;
      bottom: -22px;
      width: 52px;
      height: 52px;
      animation-delay: .8s;
    }

    .b3 {
      right: -22px;
      bottom: -26px;
      width: 76px;
      height: 76px;
      animation-delay: 1.3s;
    }

    @keyframes floaty {

      0%,
      100% {
        transform: translateY(0) scale(1);
      }

      50% {
        transform: translateY(-8px) scale(1.03);
      }
    }

    @keyframes twinkle {

      0%,
      100% {
        transform: scale(1) rotate(0deg);
        opacity: .9;
      }

      50% {
        transform: scale(1.12) rotate(6deg);
        opacity: 1;
      }
    }

    h1 {
      margin: 0 0 4px 0;
      text-align: center;
      font-size: var(--h1);
    }

    .subtitle {
      text-align: center;
      font-size: var(--sub);
      color: #6b7280;
      margin-bottom: 14px;
    }

    /* Barra estado */
    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      font-size: .9rem;
      gap: 10px;
      flex-wrap: wrap;
    }

    .xp,
    .hearts {
      display: flex;
      align-items: center;
      gap: 4px;
      font-weight: 900;
    }

    .xp span {
      color: #16a34a;
    }

    .hearts span {
      color: #f97316;
    }

    /* Progreso */
    .progress-wrapper {
      margin-bottom: 14px;
    }

    .progress-label {
      display: flex;
      justify-content: space-between;
      font-size: .8rem;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .progress {
      width: 100%;
      height: 10px;
      background: #e5e7eb;
      border-radius: 999px;
      overflow: hidden;
    }

    .progress-inner {
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, #60a5fa, #2563eb);
      transition: width .2s ease;
    }

    .card {
      border-radius: 20px;
      padding: 5px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      margin-bottom: 5px;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }

    .card.correct {
      animation: pulse .4s ease;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, .3);
    }

    .card.wrong {
      animation: shake .3s ease;
      border-color: #ef4444;
      box-shadow: 0 0 0 3px rgba(239, 68, 68, .3);
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.03);
      }

      100% {
        transform: scale(1);
      }
    }

    @keyframes shake {

      0%,
      100% {
        transform: translateX(0);
      }

      20% {
        transform: translateX(-4px);
      }

      40% {
        transform: translateX(4px);
      }

      60% {
        transform: translateX(-4px);
      }

      80% {
        transform: translateX(4px);
      }
    }

    /* ======= Ajedrez ======= */
    .board-section {
      margin-top: 10px;
    }

    .goal-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .goal {
      font-weight: 900;
      font-size: 1.02rem;
      color: #111827;
    }

    .speak-btn {
      font-size: 1.15rem;
      cursor: pointer;
      background: #eff6ff;
      border-radius: 999px;
      border: 1px solid #bfdbfe;
      padding: 6px 10px;
      transition: transform .1s ease, background .15s ease, border-color .15s ease;
    }

    .speak-btn:hover {
      transform: scale(1.06);
      background: #dbeafe;
      border-color: #93c5fd;
    }

    .board-wrap {
      display: flex;
      justify-content: center;
      margin: 8px 0 6px;
    }

    .board-frame {
      position: relative;
      width: var(--board-max);
      max-width: 100%;
      margin-inline: auto;
    }

    .board {
      width: 100%;
      aspect-ratio: 1/1;
      border-radius: 15px;
      overflow: hidden;
      border: 2px solid #93c5fd;
      box-shadow: 0 10px 22px rgba(0, 0, 0, .08);
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      touch-action: none;
      /* ‚úÖ para arrastrar con dedo */
    }

    .sq {
      aspect-ratio: 1/1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--piece);
      line-height: 1;
      position: relative;
      user-select: none;
    }

    .light {
      background: #f0f9ff;
    }

    .dark {
      background: #93c5fd;
    }

    /* Coordenadas */
    .file-labels {
      position: absolute;
      left: 0;
      right: 0;
      bottom: calc(var(--coords-gap) * -1);
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      text-align: center;
      font-size: clamp(.78rem, 2.8vw, .95rem);
      font-weight: 900;
      color: #1f2937;
      opacity: .85;
      pointer-events: none;
    }

    .rank-labels {
      position: absolute;
      top: 0;
      bottom: 0;
      left: calc(var(--coords-gap) * -1);
      display: grid;
      grid-template-rows: repeat(8, 1fr);
      align-items: center;
      justify-items: center;
      font-size: clamp(.78rem, 2.8vw, .95rem);
      font-weight: 900;
      color: #1f2937;
      opacity: .85;
      pointer-events: none;
    }

    .hint {
      text-align: center;
      font-size: .92rem;
      font-weight: 750;
      color: #374151;
      margin-top: 20px;
    }

    .mini {
      margin-top: 6px;
      text-align: center;
      font-size: .82rem;
      color: #6b7280;
      font-weight: 700;
    }

    code.k {
      background: #eef2ff;
      padding: 2px 6px;
      border-radius: 8px;
      font-weight: 900;
    }

    /* Botones opciones (mantengo por si quieres ambos modos) */
    .options {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }

    .option-btn {
      flex: 1;
      min-width: 120px;
      border-radius: 14px;
      border: 1px solid #d1d5db;
      background: #fff;
      padding: 10px 10px;
      font-size: .95rem;
      cursor: pointer;
      transition: background .15s ease, transform .1s ease, border .1s ease, opacity .1s ease;
      font-weight: 900;
    }

    .option-btn:hover:not(:disabled) {
      background: #e0f2fe;
      transform: translateY(-1px);
      border-color: #93c5fd;
    }

    .option-btn:disabled {
      cursor: default;
      opacity: .6;
    }

    .feedback {
      margin-top: 10px;
      font-size: .95rem;
      text-align: center;
      min-height: 1px;
      font-weight: 900;
    }

    .feedback.good {
      color: #16a34a;
    }

    .feedback.bad {
      color: #ef4444;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    button.main-btn {
      flex: 1;
      border: none;
      padding: 10px 12px;
      border-radius: 999px;
      font-size: var(--btn);
      cursor: pointer;
      background: linear-gradient(90deg, #60a5fa, #2563eb);
      color: #fff;
      font-weight: 900;
      letter-spacing: .02em;
      transition: transform .1s ease, box-shadow .1s ease, filter .15s ease;
      min-width: 120px;
    }

    button.main-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, .15);
      filter: brightness(1.05);
    }

    .final-message {
      display: none;
      margin-top: 14px;
      padding: 14px;
      border-radius: 16px;
      background: linear-gradient(145deg, #ecfeff, #dbeafe);
      border: 2px solid #93c5fd;
      text-align: center;
      font-size: 1rem;
      font-weight: 900;
      color: #1e3a8a;
    }

    .final-message span {
      display: block;
      margin-top: 6px;
      font-size: .9rem;
      font-weight: 800;
      color: #1f2937;
    }

    /* ‚úÖ Drag & Drop piezas */
    .piece {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      font-size: inherit;
      cursor: grab;
      touch-action: none;
      user-select: none;
      -webkit-user-select: none;
    }

    .piece.dragging {
      position: fixed;
      z-index: 9999;
      pointer-events: none;

      transform: scale(1.08);
      transform-origin: top left;
      /* ‚úÖ evita que se mueva hacia abajo/derecha */

      filter: drop-shadow(0 10px 14px rgba(0, 0, 0, .18));
    }

    /* pantallas MUY peque√±as */
    @media (max-width: 360px) {
      .nav-btn {
        min-width: 46%;
      }

      .goal-row {
        justify-content: center;
      }

      .kids-title {
        font-size: 1.35rem;
      }

      .kids-badge {
        width: 48px;
        height: 48px;
      }

      .piece.dragging {
        position: fixed;
        z-index: 9999;
        pointer-events: none;

        transform: scale(1.08);
        transform-origin: top left;
        /* ‚úÖ evita que se mueva hacia abajo/derecha */

        filter: drop-shadow(0 10px 14px rgba(0, 0, 0, .18));
      }
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- Men√∫ de navegaci√≥n -->
    <!-- <div class="nav" role="navigation" aria-label="Cursos">
      <a class="nav-btn" href="index.html">üá∫üá∏ Ingl√©s</a>
      <button class="nav-btn active" onclick="location.href='ajedrez.html'">‚ôüÔ∏è Ajedrez</button>
      <button class="nav-btn" onclick="location.href='ruta-mate.html'">‚ûó Matem√°ticas</button>
    </div> -->

    <!-- üåü Encabezado infantil: Marie Kids (CLICK -> index.html) -->
    <div class="brand-header-kids clickable"
         aria-label="Marie Kids"
         role="link"
         tabindex="0"
         onclick="goHome()"
         onkeydown="if(event.key==='Enter' || event.key===' '){ event.preventDefault(); goHome(); }">
      <div class="bubble b1"></div>
      <div class="bubble b2"></div>
      <div class="bubble b3"></div>

      <div class="star s1">‚≠ê</div>
      <div class="star s2">‚ú®</div>
      <div class="star s3">üåü</div>

      <div class="brand-row">
        <div class="kids-badge" aria-hidden="true">‚ôüÔ∏è</div>
        <div>
          <div class="kids-title">Marie Kids</div>
          <div class="kids-subtitle">
            Ajedrez divertido
            <span class="kids-pill">Mate en 1</span>
            <span class="kids-pill">üëâ Arrastra</span>
          </div>
        </div>
      </div>
    </div>

    <h1>Ajedrez ‚Ä¢ Mate en 1</h1>
    <p class="subtitle">Toca una <b>pieza blanca</b> y arr√°strala a la casilla correcta para dar mate. üß©‚ôüÔ∏è</p>

    <!-- Barra de estado -->
    <div class="status-bar">
      <div class="xp">‚úÖ Correctas: <span id="xpValue">0</span></div>
      <div class="hearts">üß† Por mejorar: <span id="heartsValue">0</span></div>
    </div>

    <!-- Barra de progreso -->
    <div class="progress-wrapper">
      <div class="progress-label">
        <span>Progreso de la sesi√≥n</span>
        <span id="progressText">0/10</span>
      </div>
      <div class="progress">
        <div class="progress-inner" id="progressBar"></div>
      </div>
    </div>

    <!-- Tarjeta principal -->
    <div class="card" id="lessonCard">

      <div class="goal-row">
        <div class="goal" id="goalText">Juegan blancas y dan mate en 1</div>
        <button class="speak-btn" type="button" onclick="speakPrompt()">üîä</button>
      </div>

      <div class="board-section">
        <div class="board-wrap">
          <div class="board-frame">
            <div class="rank-labels" id="rankLabels"></div>
            <div class="board" id="board"></div>
            <div class="file-labels" id="fileLabels"></div>
          </div>
        </div>

        <div class="hint" id="hintText">Encuentra el jaque mate en una jugada.</div>
        <div class="mini">Suelta la pieza sobre la casilla correcta (ej: <code class="k">Qg7#</code>).</div>
      </div>

      <!-- Mantengo opciones por si quieres tambi√©n modo bot√≥n (se puede ocultar si no lo usas) -->
      <div class="options" id="optionsContainer"></div>

      <div class="feedback" id="feedback"></div>

      <!-- ‚úÖ MENSAJE FINAL -->
      <div class="final-message" id="finalMessage"></div>
    </div>

    <div class="controls">
      <button class="main-btn" type="button" onclick="nextLesson()">Next</button>
      <button class="main-btn" onclick="shareApp()">üì§ Compartir app</button>
    </div>
  </div>

  <script>
    // ‚úÖ NUEVO: ir a index.html al hacer click en el encabezado
    function goHome(){
      location.href = "index.html";
    }
  </script>

  <script>
    /* ========= Datos: Problemas Mate en 1 ========= */
    const puzzles = [
      // 1) DAMA: Qg7#
      {
        id: 1,
        hint: "Mate con la dama cerca del rey.",
        board: [
          ".......‚ôö",
          ".....‚ôï..",
          "......‚ôî.",
          "........",
          "........",
          "........",
          "........",
          "........"
        ],
        moveCorrect: "Qg7#",
        moves: ["Qg7#", "Qf8+", "Qh7+"]
      },

      // 2) DAMA: Qd8#
      {
        id: 2,
        hint: "La dama entra al fondo: busca el mate en la 8¬™ fila.",
        board: [
          "....‚ôö...",
          "...‚ôï....",
          "....‚ôî...",
          "........",
          "........",
          "........",
          "........",
          "...‚ôñ...."
        ],
        moveCorrect: "Qd8#",
        moves: ["Qd8#", "Qe7+", "Qf7+"]
      },

      // 3) TORRE: Rh7#
      {
        id: 3,
        hint: "Mate cl√°sico de torre en la columna h.",
        board: [
          ".......‚ôö",
          "........",
          "......‚ôî.",
          "...‚ôó....",
          "........",
          "........",
          "........",
          ".......‚ôñ"
        ],
        moveCorrect: "Rh7#",
        moves: ["Rh7#", "Rh6+", "Rh5+"]
      },

      // 4) TORRE: Ra8#
      {
        id: 4,
        hint: "Encierra al rey en la esquina con la torre.",
        board: [
          "‚ôö.......",
          ".‚ôó......",
          "..‚ôî.....",
          "........",
          "........",
          "........",
          "........",
          "‚ôñ......."
        ],
        moveCorrect: "Ra8#",
        moves: ["Ra8#", "Ra7+", "Ra6+"]
      },

      // 5) ALFIL: Bg7#
      {
        id: 5,
        hint: "El alfil da mate con ayuda de la dama.",
        board: [
          ".......‚ôö",
          "........",
          "....‚ôî‚ôó‚ôï.",
          "........",
          "........",
          "........",
          "........",
          "........"
        ],
        moveCorrect: "Bg7#",
        moves: ["Bg7#", "Qh7+", "Qf7+"]
      },

      // 6) ALFIL: Bb7#
      {
        id: 6,
        hint: "Mate de alfil en la esquina (apoyado por torre).",
        board: [
          "‚ôö.......",
          "........",
          "..‚ôó.....",
          "........",
          "........",
          "........",
          "........",
          "‚ôñ‚ôñ..‚ôî..."
        ],
        moveCorrect: "Bb7#",
        moves: ["Bb7#", "Be8+", "Bd7+"]
      },

      // 7) CABALLO: Nf7#
      {
        id: 7,
        hint: "Mate de caballo: no se puede bloquear.",
        board: [
          ".......‚ôö",
          "......‚ôü‚ôü",
          "....‚ôî...",
          "...‚ôó..‚ôò.",
          "........",
          "........",
          "........",
          "........"
        ],
        moveCorrect: "Nf7#",
        moves: ["Nf7#", "Nh7+", "Ne6+"]
      },

      // 8) CABALLO: Ng6#
      {
        id: 8,
        hint: "El caballo salta y da mate, con el rey encerrado.",
        board: [
          ".......‚ôö",
          ".....‚ôó‚ôü‚ôú",
          "....‚ôî...",
          "....‚ôò...",
          "........",
          "........",
          "........",
          "........"
        ],
        moveCorrect: "Ng6#",
        moves: ["Ng6#", "Nd7+", "Nf7+"]
      },

      // 9) PE√ìN: f7#
      {
        id: 9,
        hint: "Mate con pe√≥n: avance simple.",
        board: [
          "....‚ôö...",
          "........",
          "....‚ôî‚ôô.‚ôó",
          "........",
          "........",
          "........",
          "........",
          "...‚ôñ...."
        ],
        moveCorrect: "f7#",
        moves: ["f7#", "Rd8+", "Bg7"]
      },

      // 10) PROMOCI√ìN: g8=Q#
      {
        id: 10,
        hint: "Promoci√≥n con mate (elige la mejor promoci√≥n).",
        board: [
          "........",
          ".....‚ôî‚ôô‚ôö",
          "........",
          "........",
          "........",
          "........",
          "........",
          "..‚ôó....."
        ],
        moveCorrect: "g8=Q#",
        moves: ["g8=Q#", "g8=R+", "g8=N+"]
      }
    ];

    let currentPuzzle = null;

    // Correctas / Por mejorar
    let correctCount = 0;
    let wrongCount = 0;

    // Para controlar que solo se cuente 1 vez la correcta por tarjeta
    let answeredCorrectly = false;

    // progreso por sesi√≥n
    let progress = 0;
    const maxProgress = 10;

    const correctSpan = document.getElementById("xpValue");
    const wrongSpan = document.getElementById("heartsValue");
    const feedbackEl = document.getElementById("feedback");
    const lessonCard = document.getElementById("lessonCard");

    const progressBar = document.getElementById("progressBar");
    const progressText = document.getElementById("progressText");

    const boardEl = document.getElementById("board");
    const hintEl = document.getElementById("hintText");

    function updateProgressBar() {
      const percent = (progress / maxProgress) * 100;
      progressBar.style.width = percent + "%";
      progressText.textContent = `${progress}/${maxProgress}`;
    }

    function randomFromArray(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    function pickPuzzle() {
      return randomFromArray(puzzles);
    }

    /* ‚úÖ Coordenadas al borde */
    function renderCoords() {
      const fileEl = document.getElementById("fileLabels");
      const rankEl = document.getElementById("rankLabels");

      const files = ["a", "b", "c", "d", "e", "f", "g", "h"];
      fileEl.innerHTML = files.map(f => `<div>${f}</div>`).join("");

      const ranks = ["8", "7", "6", "5", "4", "3", "2", "1"];
      rankEl.innerHTML = ranks.map(r => `<div>${r}</div>`).join("");
    }

    function rcToSquare(r, c) {
      const files = ["a", "b", "c", "d", "e", "f", "g", "h"];
      const rank = 8 - r;
      return files[c] + rank;
    }

    /* ‚úÖ Render del tablero con piezas "arrastrables" */
    function renderBoard(boardRows) {
      boardEl.innerHTML = "";

      for (let r = 0; r < 8; r++) {
        const row = boardRows[r];
        for (let c = 0; c < 8; c++) {
          const sq = document.createElement("div");
          const isDark = (r + c) % 2 === 1;
          sq.className = "sq " + (isDark ? "dark" : "light");

          const square = rcToSquare(r, c);
          sq.dataset.square = square;

          const ch = row[c];
          if (ch !== ".") {
            const piece = document.createElement("div");
            piece.className = "piece";
            piece.textContent = ch;
            piece.dataset.piece = ch;
            piece.dataset.from = square;

            const whitePieces = ["‚ôî", "‚ôï", "‚ôñ", "‚ôó", "‚ôò", "‚ôô"];
            if (whitePieces.includes(ch)) {
              piece.addEventListener("pointerdown", onPieceDown);
            }

            sq.appendChild(piece);
          }

          boardEl.appendChild(sq);
        }
      }

      renderCoords();
    }

    function createOptions() {
      const container = document.getElementById("optionsContainer");
      container.innerHTML = "";

      const opts = [...currentPuzzle.moves];
      shuffleArray(opts);

      opts.forEach(move => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = move;
        btn.className = "option-btn";
        btn.onclick = () => checkAnswer(move, btn);
        container.appendChild(btn);
      });
    }

    function renderLesson() {
      answeredCorrectly = false;
      currentPuzzle = pickPuzzle();

      document.getElementById("goalText").textContent = "Juegan blancas y dan mate en 1";
      hintEl.textContent = currentPuzzle.hint;

      feedbackEl.textContent = "";
      feedbackEl.classList.remove("good", "bad");
      lessonCard.classList.remove("correct", "wrong");

      const finalBox = document.getElementById("finalMessage");
      finalBox.style.display = "none";
      finalBox.innerHTML = "";

      renderBoard(currentPuzzle.board);
      createOptions(); // si no quieres botones, puedes borrar esta l√≠nea
    }

    function speakText(text) {
      if (!("speechSynthesis" in window)) return;
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = "es-ES";
      utter.rate = 0.95;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
    }

    function speakPrompt() {
      if (!currentPuzzle) return;
      speakText("Juegan blancas y dan mate en una. " + currentPuzzle.hint);
    }

    function checkAnswer(answer, clickedBtn) {
      if (!currentPuzzle) return;
      if (answeredCorrectly) return;

      if (answer === currentPuzzle.moveCorrect) {
        answeredCorrectly = true;

        correctCount++;
        correctSpan.textContent = correctCount;

        if (progress < maxProgress) {
          progress += 1;
          updateProgressBar();
        }

        feedbackEl.textContent = randomFromArray([
          "‚úÖ ¬°Mate! Excelente.",
          "‚úÖ ¬°Correcto! Gran jugada.",
          "‚úÖ ¬°Muy bien! Jaque mate.",
          "‚úÖ ¬°Perfecto! Mate en 1."
        ]);
        feedbackEl.classList.remove("bad");
        feedbackEl.classList.add("good");

        lessonCard.classList.remove("wrong");
        lessonCard.classList.add("correct");

        document.querySelectorAll(".option-btn").forEach(b => { b.disabled = true; });

        if (progress >= maxProgress) {
          const finalBox = document.getElementById("finalMessage");
          finalBox.innerHTML = `
            üéâ ¬°Sesi√≥n completada!<br>
            Lograste <strong>${correctCount}</strong> mates correctos.
            <span>¬°Sigue practicando! ‚ôüÔ∏è‚ú®</span>
          `;
          finalBox.style.display = "block";
          feedbackEl.textContent = "‚úÖ ¬°Sesi√≥n completa! Excelente trabajo.";
          feedbackEl.classList.add("good");
        }

      } else {
        wrongCount++;
        wrongSpan.textContent = wrongCount;

        feedbackEl.textContent = "‚ùå No es mate. Intenta otra opci√≥n.";
        feedbackEl.classList.remove("good");
        feedbackEl.classList.add("bad");

        lessonCard.classList.remove("correct");
        lessonCard.classList.add("wrong");

        if (clickedBtn) clickedBtn.disabled = true;
      }
    }

    function nextLesson() {
      renderLesson();
    }

    /* =========================
       ‚úÖ DRAG & DROP para mover piezas
       ========================= */
    let drag = null; // { el, piece, from, offsetX, offsetY, homeSquare }

    function isPromotionMove(move) {
      return move.includes("=");
    }

    function buildMoveNotation(pieceEmoji, toSq) {
      const map = { "‚ôï": "Q", "‚ôñ": "R", "‚ôó": "B", "‚ôò": "N", "‚ôî": "K", "‚ôô": "" };
      const letter = map[pieceEmoji] ?? "";
      return `${letter}${toSq}`;
    }

    function normalizeMove(m) {
      return String(m).replace(/\s+/g, "");
    }

    function onPieceDown(e) {
      if (!currentPuzzle || answeredCorrectly) return;

      const el = e.currentTarget;
      el.setPointerCapture(e.pointerId);

      const rect = el.getBoundingClientRect();
      drag = {
        el,
        piece: el.dataset.piece,
        from: el.dataset.from,
        offsetX: e.clientX - rect.left,
        offsetY: e.clientY - rect.top
      };

      el.classList.add("dragging");
      el.style.left = (e.clientX - drag.offsetX) + "px";
      el.style.top = (e.clientY - drag.offsetY) + "px";

      window.addEventListener("pointermove", onPieceMove);
      window.addEventListener("pointerup", onPieceUp, { once: true });
    }

    function onPieceMove(e) {
      if (!drag) return;
      drag.el.style.left = (e.clientX - drag.offsetX) + "px";
      drag.el.style.top = (e.clientY - drag.offsetY) + "px";
    }

    function onPieceUp(e) {
      window.removeEventListener("pointermove", onPieceMove);
      if (!drag) return;

      // detectar casilla destino
      const target = document.elementFromPoint(e.clientX, e.clientY);
      const sq = target?.closest?.(".sq");
      const toSq = sq?.dataset?.square;

      // devolver visualmente la pieza a su casilla original (no movemos tablero real)
      drag.el.classList.remove("dragging");
      drag.el.style.left = "";
      drag.el.style.top = "";

      if (!toSq) { drag = null; return; }

      // construir jugada
      let move = buildMoveNotation(drag.piece, toSq);

      const correct = normalizeMove(currentPuzzle.moveCorrect);

      // promoci√≥n simple (solo para el puzzle 10)
      if (isPromotionMove(correct)) {
        if (drag.piece === "‚ôô" && toSq === "g8") move = "g8=Q";
      }

      if (correct.endsWith("#") && !move.endsWith("#")) move += "#";

      if (normalizeMove(move) === correct) {
        checkAnswer(currentPuzzle.moveCorrect, null);
      } else {
        wrongCount++;
        wrongSpan.textContent = wrongCount;

        feedbackEl.textContent = "‚ùå No es mate. Intenta mover a otra casilla.";
        feedbackEl.classList.remove("good");
        feedbackEl.classList.add("bad");

        lessonCard.classList.remove("correct");
        lessonCard.classList.add("wrong");
      }

      drag = null;
    }

    // Inicializar
    updateProgressBar();
    renderLesson();
  </script>

  <script>
    // Registrar Service Worker (PWA)
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./service-worker.js").catch(() => { });
      });
    }
  </script>

  <script>
    function shareApp() {
      const shareData = {
        title: "Mini Cursos",
        text: "üìö Aprende ingl√©s, ajedrez y matem√°ticas con esta app educativa",
        url: window.location.href
      };

      if (navigator.share) {
        navigator.share(shareData)
          .catch(() => { });
      } else {
        // Fallback para navegadores que no soportan Web Share
        navigator.clipboard.writeText(shareData.url);
        alert("üîó Link copiado para compartir");
      }
    }
  </script>
</body>

</html>
