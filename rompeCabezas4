<!doctype html>
<html lang="es">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Marie Kids ‚Ä¢ Rompecabezas (Galer√≠a + Guardado)</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1976d2">
    <style>
      :root {
        --bg1: #dbeafe;
        --bg2: #e0f2fe;
        --card: #ffffff;
        --shadow: 0 18px 40px rgba(0, 0, 0, .10);
        --radius: 22px;

        --board: min(92vw, 420px);
        --slotGap: clamp(8px, 2.2vw, 12px);

        --accent: #2563eb;
        --accent2: #22c55e;
        --danger: #ef4444;
        --muted: #64748b;

        --pieceShadow: 0 12px 24px rgba(0, 0, 0, .18);

        --thumb: 78px;
      }

      * {
        box-sizing: border-box;
        font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      }

      body {
        margin: 0;
        min-height: 100dvh;
        display: flex;
        justify-content: center;
        padding: 18px;
        background:
          radial-gradient(1200px 800px at 10% 10%, var(--bg1) 0%, transparent 60%),
          radial-gradient(900px 700px at 90% 20%, var(--bg2) 0%, transparent 60%),
          linear-gradient(145deg, var(--bg2), var(--bg1));
      }

      .app {
        width: 100%;
        max-width: 1100px;
        background: var(--card);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: clamp(16px, 2.6vw, 26px);
      }

      /* =========================================
         ‚úÖ ENCABEZADO MARIE KIDS (AGREGADO)
         - Clic para volver a index.html
         - Burbujas / brillo
         ========================================= */
      .mkHeader {
        position: relative;
        border-radius: 22px;
        padding: 14px 14px 12px;
        overflow: hidden;
        margin-bottom: 12px;
        border: 1px solid rgba(2, 6, 23, .10);
        background:
          radial-gradient(900px 420px at 0% 0%, rgba(37, 99, 235, .14), transparent 60%),
          radial-gradient(700px 380px at 100% 10%, rgba(34, 197, 94, .14), transparent 55%),
          linear-gradient(135deg, rgba(255, 255, 255, .85), rgba(248, 250, 252, .72));
      }

      .mkHeader::after {
        content: "";
        position: absolute;
        inset: -60px -80px auto auto;
        width: 240px;
        height: 240px;
        background:
          radial-gradient(circle at 25% 30%, rgba(37, 99, 235, .25), transparent 55%),
          radial-gradient(circle at 70% 60%, rgba(34, 197, 94, .22), transparent 55%),
          radial-gradient(circle at 35% 80%, rgba(99, 102, 241, .18), transparent 55%);
        filter: blur(1px);
        transform: rotate(12deg);
        pointer-events: none;
      }

      .mkHeader::before {
        content: "";
        position: absolute;
        inset: 0;
        background:
          radial-gradient(700px 120px at 20% -20%, rgba(255,255,255,.55), transparent 60%),
          radial-gradient(500px 120px at 80% 0%, rgba(255,255,255,.35), transparent 55%);
        pointer-events: none;
      }

      .mkBrand {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        position: relative;
        z-index: 2;
      }

      .mkBrandLeft {
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 0;
      }

      .mkLogo {
        width: 44px;
        height: 44px;
        border-radius: 16px;
        background: linear-gradient(135deg, rgba(37, 99, 235, 1), rgba(99, 102, 241, 1));
        box-shadow: 0 14px 26px rgba(37, 99, 235, .18);
        display: grid;
        place-items: center;
        color: #fff;
        font-weight: 950;
        letter-spacing: .2px;
        user-select: none;
        flex: 0 0 auto;
      }

      .mkTitleWrap {
        display: grid;
        line-height: 1.05;
        min-width: 0;
      }

      .mkTitle {
        font-weight: 950;
        font-size: 18px;
        color: #0f172a;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .mkSubtitle {
        font-size: 12px;
        color: rgba(15, 23, 42, .65);
        font-weight: 800;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .mkGoHome {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border-radius: 999px;
        padding: 8px 12px;
        border: 1px solid rgba(2, 6, 23, .10);
        background: rgba(255, 255, 255, .75);
        color: #0f172a;
        text-decoration: none;
        font-weight: 900;
        font-size: 12px;
        position: relative;
        z-index: 2;
        transition: transform .12s ease, box-shadow .12s ease;
      }

      .mkGoHome:hover {
        transform: translateY(-1px);
        box-shadow: 0 14px 28px rgba(0,0,0,.10);
        color: #0f172a;
      }

      /* ‚úÖ Hace que el header completo sea clicable (opcional) */
      .mkHeaderLink {
        position: absolute;
        inset: 0;
        z-index: 1;
        border-radius: 22px;
      }

      .hero {
        position: relative;
        border-radius: 20px;
        padding: 18px 16px 14px;
        overflow: hidden;
        background: linear-gradient(135deg, rgba(37, 99, 235, .10), rgba(34, 197, 94, .10));
        border: 1px solid rgba(2, 6, 23, .08);
        margin-bottom: 14px;
      }

      .bubbles {
        position: absolute;
        inset: -40px -40px auto auto;
        width: 220px;
        height: 220px;
        background:
          radial-gradient(circle at 25% 30%, rgba(37, 99, 235, .22), transparent 55%),
          radial-gradient(circle at 70% 60%, rgba(34, 197, 94, .22), transparent 55%),
          radial-gradient(circle at 35% 80%, rgba(99, 102, 241, .18), transparent 55%);
        filter: blur(1px);
        pointer-events: none;
        transform: rotate(10deg);
      }

      .hero h1 {
        margin: 0;
        font-size: clamp(18px, 2.2vw, 24px);
        letter-spacing: .2px;
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(37, 99, 235, .10);
        border: 1px solid rgba(37, 99, 235, .18);
        color: #1e40af;
        font-weight: 700;
        font-size: 12px;
      }

      .sub {
        margin: 8px 0 0;
        color: var(--muted);
        font-size: 13px;
        line-height: 1.35;
      }

      .panel {
        border-radius: 18px;
        border: 1px solid rgba(2, 6, 23, .10);
        background: rgba(248, 250, 252, .65);
        padding: 14px;
      }

      .boardWrap {
        display: grid;
        gap: 14px;
        grid-template-columns: 1fr;
      }

      @media (min-width: 900px) {
        .boardWrap {
          grid-template-columns: 1fr 1fr;
          align-items: start;
        }
      }

      .board {
        width: var(--board);
        max-width: 100%;
        margin: 0 auto;
        aspect-ratio: 1/1;
        border-radius: 18px;
        background: rgba(2, 6, 23, .03);
        border: 1px solid rgba(2, 6, 23, .10);
        padding: var(--slotGap);
        display: grid;
        gap: var(--slotGap);
        position: relative;
        overflow: hidden;
      }

      .slot {
        border-radius: 14px;
        border: 1px dashed rgba(2, 6, 23, .18);
        background: rgba(255, 255, 255, .7);
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform .12s ease, background .12s ease, border-color .12s ease;
        user-select: none;
      }

      .slot.good {
        border-color: rgba(34, 197, 94, .55);
        background: rgba(34, 197, 94, .08);
      }

      .slot.hint {
        outline: 3px solid rgba(37, 99, 235, .35);
        outline-offset: 2px;
      }

      .tray {
        width: var(--board);
        max-width: 100%;
        margin: 0 auto;
        border-radius: 18px;
        border: 1px solid rgba(2, 6, 23, .10);
        background: rgba(255, 255, 255, .75);
        padding: 12px;
        min-height: 140px;
        position: relative;
        overflow: hidden;
      }

      .trayTop {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 10px;
      }

      .trayTitle {
        font-weight: 950;
        font-size: 14px;
        color: #0f172a;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .trayGrid {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: flex-start;
        justify-content: flex-start;
        min-height: 92px;
      }

      .piece {
        width: 74px;
        aspect-ratio: 1/1;
        border-radius: 14px;
        box-shadow: var(--pieceShadow);
        border: 1px solid rgba(2, 6, 23, .12);
        background-size: cover;
        background-repeat: no-repeat;
        background-position: center;
        cursor: grab;
        touch-action: none;
        position: relative;
        transition: transform .12s ease, opacity .12s ease;
        user-select: none;
      }

      .piece:active {
        cursor: grabbing;
        transform: scale(1.03);
      }

      .piece.placed {
        width: 100%;
        height: 100%;
        border-radius: 12px;
        box-shadow: none;
        border: none;
        cursor: default;
      }

      .piece.dragging {
        opacity: .92;
        transform: scale(1.06);
        z-index: 9999;
      }

      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
        margin-top: 12px;
      }

      .btn-soft {
        border: 1px solid rgba(2, 6, 23, .10) !important;
        background: rgba(255, 255, 255, .75) !important;
        color: #0f172a !important;
        border-radius: 12px !important;
        font-weight: 900 !important;
      }

      .btn-accent {
        border: none !important;
        background: linear-gradient(135deg, rgba(37, 99, 235, 1), rgba(99, 102, 241, 1)) !important;
        border-radius: 12px !important;
        font-weight: 950 !important;
      }

      .btn-green {
        border: none !important;
        background: linear-gradient(135deg, rgba(34, 197, 94, 1), rgba(16, 185, 129, 1)) !important;
        border-radius: 12px !important;
        font-weight: 950 !important;
      }

      .stat {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
        font-size: 13px;
        color: #0f172a;
      }

      .badgeStat {
        border: 1px solid rgba(2, 6, 23, .10);
        background: rgba(255, 255, 255, .75);
        padding: 8px 10px;
        border-radius: 14px;
        display: flex;
        gap: 8px;
        align-items: center;
        font-weight: 900;
      }

      .smallMuted {
        color: var(--muted);
        font-weight: 800;
      }

      .winOverlay {
        position: fixed;
        inset: 0;
        background: rgba(2, 6, 23, .45);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 16px;
        z-index: 99999;
      }

      .winCard {
        width: min(560px, 94vw);
        background: white;
        border-radius: 22px;
        box-shadow: 0 24px 70px rgba(0, 0, 0, .35);
        border: 1px solid rgba(2, 6, 23, .12);
        overflow: hidden;
      }

      .winTop {
        padding: 18px 18px 12px;
        background: linear-gradient(135deg, rgba(34, 197, 94, .14), rgba(37, 99, 235, .14));
        border-bottom: 1px solid rgba(2, 6, 23, .08);
      }

      .winTop h2 {
        margin: 0;
        font-size: 20px;
        font-weight: 950;
        color: #0f172a;
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .winBody {
        padding: 14px 18px 18px;
        color: #0f172a;
      }

      .confetti {
        position: absolute;
        inset: 0;
        pointer-events: none;
        overflow: hidden;
      }

      .conf {
        position: absolute;
        width: 10px;
        height: 16px;
        border-radius: 3px;
        opacity: .95;
        animation: fall 1.3s linear forwards;
      }

      @keyframes fall {
        0% {
          transform: translateY(-40px) rotate(0deg);
          opacity: 1;
        }

        100% {
          transform: translateY(120vh) rotate(380deg);
          opacity: 0.85;
        }
      }

      .previewBox {
        width: var(--board);
        max-width: 100%;
        margin: 0 auto;
        border-radius: 18px;
        border: 1px solid rgba(2, 6, 23, .10);
        background: rgba(255, 255, 255, .75);
        overflow: hidden;
      }

      .previewImg {
        width: 100%;
        aspect-ratio: 1/1;
        background-size: cover;
        background-position: center;
        filter: saturate(1.02);
      }

      .previewFooter {
        padding: 10px 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        border-top: 1px solid rgba(2, 6, 23, .08);
        font-size: 13px;
        color: var(--muted);
      }

      /* ===== Galer√≠a ===== */
      .galleryHeader {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }

      .gallery {
        display: flex;
        gap: 10px;
        overflow: auto;
        padding-bottom: 6px;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
      }

      .thumb {
        width: var(--thumb);
        height: var(--thumb);
        border-radius: 16px;
        border: 2px solid rgba(2, 6, 23, .10);
        background: rgba(255, 255, 255, .85);
        box-shadow: 0 10px 24px rgba(0, 0, 0, .10);
        flex: 0 0 auto;
        overflow: hidden;
        cursor: pointer;
        position: relative;
        scroll-snap-align: start;
        transition: transform .12s ease, border-color .12s ease;
        user-select: none;
      }

      .thumb:hover {
        transform: translateY(-2px);
      }

      .thumb.active {
        border-color: rgba(37, 99, 235, .65);
        outline: 3px solid rgba(37, 99, 235, .25);
        outline-offset: 2px;
      }

      .thumb .img {
        width: 100%;
        height: 100%;
        background-size: cover;
        background-position: center;
      }

      .thumb .tag {
        position: absolute;
        left: 8px;
        bottom: 8px;
        padding: 4px 7px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 950;
        background: rgba(255, 255, 255, .82);
        border: 1px solid rgba(2, 6, 23, .10);
        color: #0f172a;
        backdrop-filter: blur(6px);
      }
    </style>
  </head>

  <body>
    <div class="app">

      <!-- ‚úÖ ENCABEZADO MARIE KIDS (AGREGADO) -->
      <div class="mkHeader">
        <a class="mkHeaderLink" href="index.html" aria-label="Volver a Marie Kids"></a>
        <div class="mkBrand">
          <div class="mkBrandLeft">
            <div class="mkLogo">MK</div>
            <div class="mkTitleWrap">
              <div class="mkTitle">Marie Kids</div>
              <div class="mkSubtitle">Mini Cursos ‚Ä¢ Juegos ‚Ä¢ Aprendizaje</div>
            </div>
          </div>
          <a class="mkGoHome" href="index.html" title="Volver al inicio">
            üè† Inicio
          </a>
        </div>
      </div>

      <div class="hero">
        <div class="bubbles"></div>
        <h1>
          üß© Rompecabezas Infantil
          <span class="pill">Lista desplegable</span>
          <span class="pill">Categor√≠as</span>
          <span class="pill">Guarda ajustes</span>
        </h1>
        <p class="sub">
          Elige una imagen desde el desplegable o tocando una miniatura. Se guarda tu selecci√≥n y nivel.
        </p>
      </div>

      <div class="row g-3">
        <div class="col-12 col-lg-7">
          <div class="panel">
            <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
              <div class="d-flex flex-wrap gap-2 align-items-center">
                <div class="input-group" style="max-width: 240px;">
                  <span class="input-group-text">Nivel</span>
                  <select id="level" class="form-select">
                    <option value="2">F√°cil (2x2)</option>
                    <option value="3" selected>Normal (3x3)</option>
                    <option value="4">Dif√≠cil (4x4)</option>
                  </select>
                </div>

                <button id="btnNew" class="btn btn-accent text-white px-3">üîÑ Nuevo</button>
                <button id="btnHint" class="btn btn-soft px-3">üí° Pista</button>
                <button id="btnAuto" class="btn btn-soft px-3">ü§ñ Autocolocar 1</button>
              </div>

              <div class="stat">
                <div class="badgeStat">‚úÖ <span id="done">0</span><span class="smallMuted">/</span><span
                    id="total">0</span></div>
                <div class="badgeStat">‚è±Ô∏è <span id="time">00:00</span></div>
                <div class="badgeStat">‚≠ê <span id="moves">0</span></div>
              </div>
            </div>

            <!-- Galer√≠a + select -->
            <div class="mt-3">
              <div class="galleryHeader">
                <div style="font-weight:950;">üñºÔ∏è Im√°genes</div>
                <div class="d-flex flex-wrap gap-2 align-items-center">
                  <select id="catFilter" class="form-select form-select-sm" style="max-width: 190px;">
                    <option value="all">Todas</option>
                    <option value="animal">Animales</option>
                    <option value="fruit">Frutas</option>
                    <option value="demo">Demo</option>
                    <option value="custom">Mis im√°genes</option>
                  </select>

                  <!-- ‚úÖ reemplazo del buscador: lista desplegable -->
                  <select id="imgSelect" class="form-select form-select-sm" style="max-width: 260px;">
                    <option value="">Seleccionar imagen‚Ä¶</option>
                  </select>

                  <button id="btnClearGallery" class="btn btn-soft btn-sm">üßπ Limpiar ‚ÄúMis im√°genes‚Äù</button>
                </div>
              </div>

              <div id="gallery" class="gallery"></div>
              <div class="smallMuted mt-1">Puedes elegir por lista o tocando una miniatura.</div>
            </div>

            <div class="mt-3 boardWrap">
              <div>
                <div id="board" class="board" aria-label="Tablero del rompecabezas"></div>

                <div class="controls">
                  <div class="d-flex gap-2 flex-wrap">
                    <label class="btn btn-soft mb-0">
                      üì∑ Cargar imagen
                      <input id="file" type="file" accept="image/*" hidden>
                    </label>
                    <button id="btnShuffle" class="btn btn-soft">üîÄ Mezclar piezas</button>
                  </div>

                  <div class="d-flex align-items-center gap-2">
                    <span class="smallMuted">Sonidos</span>
                    <div class="form-check form-switch m-0">
                      <input class="form-check-input" type="checkbox" id="sound" checked>
                    </div>
                  </div>
                </div>
              </div>

              <div>
                <div class="previewBox">
                  <div id="preview" class="previewImg"></div>
                  <div class="previewFooter">
                    <span>üß† Imagen completa (referencia)</span>
                    <button id="btnTogglePreview" class="btn btn-green text-white btn-sm">Ver/Ocultar</button>
                  </div>
                </div>

                <div class="tray mt-3">
                  <div class="trayTop">
                    <div class="trayTitle">üß© Piezas</div>
                    <div class="smallMuted">Arrastra al tablero</div>
                  </div>
                  <div id="trayGrid" class="trayGrid"></div>
                </div>
              </div>
            </div>

            <div class="mt-3 smallMuted">
              Tip: Si una pieza est√° cerca, se pega sola (snap).
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-5">
          <div class="panel">
            <h5 class="mb-2" style="font-weight:950;">üéÆ C√≥mo jugar</h5>
            <ul class="mb-2">
              <li>Elige categor√≠a y luego una imagen en el desplegable.</li>
              <li>Arma el rompecabezas arrastrando las piezas.</li>
              <li>Se guarda tu selecci√≥n y el nivel autom√°ticamente.</li>
            </ul>
            <div class="alert alert-primary mb-0" style="border-radius: 16px;">
              ‚úÖ ‚ÄúMis im√°genes‚Äù tambi√©n se guarda (hasta que lo limpies).
            </div>
          </div>

          <div class="panel mt-3">
            <h5 class="mb-2" style="font-weight:950;">‚öôÔ∏è Ajustes</h5>
            <div class="d-flex flex-wrap gap-2">
              <button id="btnResetTime" class="btn btn-soft">‚è±Ô∏è Reiniciar tiempo</button>
              <button id="btnShowAllHints" class="btn btn-soft">üîé Marcar casillas</button>
              <button id="btnHideHints" class="btn btn-soft">üôà Quitar marcas</button>
              <button id="btnResetAll" class="btn btn-soft">‚ôªÔ∏è Reset total</button>
            </div>
            <div class="smallMuted mt-2">
              ‚ÄúReset total‚Äù borra el guardado (localStorage) y vuelve al inicio.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Ganaste -->
    <div id="winOverlay" class="winOverlay">
      <div class="winCard position-relative">
        <div id="confetti" class="confetti"></div>
        <div class="winTop">
          <h2>üèÜ ¬°Excelente! ¬°Lo lograste!</h2>
        </div>
        <div class="winBody">
          <div class="d-flex flex-wrap gap-2">
            <div class="badgeStat">‚è±Ô∏è Tiempo: <span id="winTime">00:00</span></div>
            <div class="badgeStat">‚≠ê Movimientos: <span id="winMoves">0</span></div>
            <div class="badgeStat">üß© Nivel: <span id="winLevel">3x3</span></div>
          </div>
          <div class="mt-3 d-flex gap-2 flex-wrap">
            <button id="btnNext" class="btn btn-green text-white px-3">‚û°Ô∏è Siguiente nivel</button>
            <button id="btnAgain" class="btn btn-accent text-white px-3">üîÑ Jugar otra vez</button>
            <button id="btnCloseWin" class="btn btn-soft px-3">‚ùå Cerrar</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      (() => {
        /* ============================
           ‚úÖ LocalStorage keys
        ============================ */
        const LS = {
          activeId: 'mk_puzzle_active_id',
          level: 'mk_puzzle_level',
          sound: 'mk_puzzle_sound',
          preview: 'mk_puzzle_preview',
          cat: 'mk_puzzle_cat',
          custom: 'mk_puzzle_custom_items'
        };

        function lsGet(key, fallback = null) {
          try {
            const v = localStorage.getItem(key);
            return v === null ? fallback : JSON.parse(v);
          } catch { return fallback; }
        }
        function lsSet(key, value) {
          try { localStorage.setItem(key, JSON.stringify(value)); } catch { }
        }
        function lsDel(key) {
          try { localStorage.removeItem(key); } catch { }
        }

        /* ============================
           ‚úÖ Canvas generators
        ============================ */
        function makeCanvas(size = 900) {
          const c = document.createElement('canvas');
          c.width = c.height = size;
          return c;
        }
        function text(ctx, str, x, y, size, color = 'rgba(255,255,255,.92)', weight = 900, align = 'left') {
          ctx.save();
          ctx.fillStyle = color;
          ctx.font = `${weight} ${size}px system-ui,Segoe UI,sans-serif`;
          ctx.textAlign = align;
          ctx.fillText(str, x, y);
          ctx.restore();
        }
        function bgGradient(ctx, size, c1, c2) {
          const g = ctx.createLinearGradient(0, 0, size, size);
          g.addColorStop(0, c1);
          g.addColorStop(1, c2);
          ctx.fillStyle = g;
          ctx.fillRect(0, 0, size, size);
        }
        function clouds(ctx, size) {
          function cloud(x, y, s) {
            ctx.fillStyle = 'rgba(255,255,255,.92)';
            ctx.beginPath();
            ctx.arc(x, y, s * 0.55, 0, Math.PI * 2);
            ctx.arc(x + s * 0.5, y + s * 0.08, s * 0.45, 0, Math.PI * 2);
            ctx.arc(x + s * 0.95, y, s * 0.52, 0, Math.PI * 2);
            ctx.arc(x + s * 0.55, y - s * 0.28, s * 0.45, 0, Math.PI * 2);
            ctx.closePath();
            ctx.fill();
            ctx.fillStyle = 'rgba(255,255,255,.35)';
            ctx.fillRect(x - s * 0.1, y, s * 1.25, s * 0.7);
          }
          cloud(size * 0.16, size * 0.28, size * 0.12);
          cloud(size * 0.62, size * 0.26, size * 0.14);
        }
        function face(ctx, x, y, r, base = '#fde047') {
          ctx.fillStyle = 'rgba(255,255,255,.20)';
          ctx.beginPath(); ctx.arc(x, y, r * 1.2, 0, Math.PI * 2); ctx.fill();

          ctx.fillStyle = base;
          ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI * 2); ctx.fill();
          ctx.strokeStyle = 'rgba(15,23,42,.12)';
          ctx.lineWidth = r * 0.08;
          ctx.stroke();

          ctx.fillStyle = '#0f172a';
          ctx.beginPath(); ctx.arc(x - r * 0.35, y - r * 0.15, r * 0.10, 0, Math.PI * 2); ctx.fill();
          ctx.beginPath(); ctx.arc(x + r * 0.35, y - r * 0.15, r * 0.10, 0, Math.PI * 2); ctx.fill();

          ctx.strokeStyle = '#0f172a';
          ctx.lineWidth = r * 0.12;
          ctx.lineCap = 'round';
          ctx.beginPath();
          ctx.arc(x, y + r * 0.05, r * 0.45, 0.15 * Math.PI, 0.85 * Math.PI);
          ctx.stroke();
        }

        function makeRainbowDemo(size = 900) {
          const c = makeCanvas(size), ctx = c.getContext('2d');
          bgGradient(ctx, size, '#60a5fa', '#34d399');
          clouds(ctx, size);

          const cx = size * 0.5, cy = size * 0.62;
          const rings = [
            ['#ef4444', 0.42],
            ['#f59e0b', 0.38],
            ['#facc15', 0.34],
            ['#22c55e', 0.30],
            ['#3b82f6', 0.26],
            ['#8b5cf6', 0.22],
          ];
          rings.forEach(([color, rr]) => {
            ctx.beginPath();
            ctx.arc(cx, cy, size * rr, Math.PI, 2 * Math.PI);
            ctx.lineWidth = size * 0.06;
            ctx.strokeStyle = color;
            ctx.globalAlpha = 0.85;
            ctx.stroke();
          });
          ctx.globalAlpha = 1;

          face(ctx, size * 0.76, size * 0.56, size * 0.12, '#fde047');
          text(ctx, 'Marie Kids', size * 0.10, size * 0.16, Math.floor(size * 0.07), 'rgba(255,255,255,.92)', 950, 'left');
          text(ctx, '¬°Arma el rompecabezas!', size * 0.10, size * 0.23, Math.floor(size * 0.045), 'rgba(255,255,255,.78)', 900, 'left');

          return c.toDataURL('image/png');
        }

        function animalBase(size, title, emoji, bg1, bg2, drawFn) {
          const c = makeCanvas(size), ctx = c.getContext('2d');
          bgGradient(ctx, size, bg1, bg2);
          clouds(ctx, size);
          drawFn(ctx, size);
          text(ctx, title.toUpperCase(), size * 0.5, size * 0.16, Math.floor(size * 0.09), 'rgba(255,255,255,.92)', 950, 'center');
          text(ctx, emoji, size * 0.5, size * 0.26, Math.floor(size * 0.08), 'rgba(255,255,255,.92)', 900, 'center');
          return c.toDataURL('image/png');
        }

        function fruitBase(size, title, emoji, bg1, bg2, drawFn) {
          const c = makeCanvas(size), ctx = c.getContext('2d');
          bgGradient(ctx, size, bg1, bg2);
          drawFn(ctx, size);
          text(ctx, title.toUpperCase(), size * 0.5, size * 0.16, Math.floor(size * 0.09), 'rgba(255,255,255,.92)', 950, 'center');
          text(ctx, emoji, size * 0.5, size * 0.26, Math.floor(size * 0.08), 'rgba(255,255,255,.92)', 900, 'center');
          return c.toDataURL('image/png');
        }

        /* ===== ANIMALES (10) ===== */
        function makeCat(size = 900) {
          return animalBase(size, 'Gatito', 'üê±', '#60a5fa', '#a78bfa', (ctx, S) => {
            const cx = S * 0.5, cy = S * 0.58, r = S * 0.22;
            ctx.fillStyle = 'rgba(0,0,0,.12)'; ctx.beginPath(); ctx.ellipse(cx, cy + r * 0.95, r * 0.95, r * 0.25, 0, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#fbbf24'; ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#f59e0b';
            ctx.beginPath(); ctx.moveTo(cx - r * 0.72, cy - r * 0.25); ctx.lineTo(cx - r * 0.95, cy - r * 0.95); ctx.lineTo(cx - r * 0.25, cy - r * 0.70); ctx.closePath(); ctx.fill();
            ctx.beginPath(); ctx.moveTo(cx + r * 0.72, cy - r * 0.25); ctx.lineTo(cx + r * 0.95, cy - r * 0.95); ctx.lineTo(cx + r * 0.25, cy - r * 0.70); ctx.closePath(); ctx.fill();
            ctx.fillStyle = '#0f172a'; ctx.beginPath(); ctx.arc(cx - r * 0.35, cy - r * 0.05, r * 0.10, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.arc(cx + r * 0.35, cy - r * 0.05, r * 0.10, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#fb7185'; ctx.beginPath(); ctx.arc(cx, cy + r * 0.12, r * 0.07, 0, Math.PI * 2); ctx.fill();
            ctx.strokeStyle = '#0f172a'; ctx.lineWidth = r * 0.06; ctx.lineCap = 'round';
            ctx.beginPath(); ctx.arc(cx - r * 0.10, cy + r * 0.16, r * 0.18, 0.15 * Math.PI, 0.85 * Math.PI); ctx.stroke();
            ctx.beginPath(); ctx.arc(cx + r * 0.10, cy + r * 0.16, r * 0.18, 0.15 * Math.PI, 0.85 * Math.PI); ctx.stroke();
          });
        }

        function makePanda(size = 900) {
          return animalBase(size, 'Panda', 'üêº', '#34d399', '#60a5fa', (ctx, S) => {
            const cx = S * 0.5, cy = S * 0.58, r = S * 0.22;
            ctx.fillStyle = 'rgba(15,23,42,.10)';
            for (let i = 0; i < 8; i++) { const x = S * (0.08 + i * 0.12); ctx.fillRect(x, S * 0.08, S * 0.02, S * 0.84); }

            ctx.fillStyle = 'rgba(0,0,0,.12)'; ctx.beginPath(); ctx.ellipse(cx, cy + r * 1.00, r * 0.95, r * 0.25, 0, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = 'rgba(255,255,255,.92)'; ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#0f172a'; ctx.beginPath(); ctx.arc(cx - r * 0.70, cy - r * 0.85, r * 0.28, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.arc(cx + r * 0.70, cy - r * 0.85, r * 0.28, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = 'rgba(15,23,42,.75)';
            ctx.beginPath(); ctx.ellipse(cx - r * 0.38, cy - r * 0.10, r * 0.28, r * 0.20, -0.4, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.ellipse(cx + r * 0.38, cy - r * 0.10, r * 0.28, r * 0.20, 0.4, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#0f172a'; ctx.beginPath(); ctx.arc(cx - r * 0.38, cy - r * 0.10, r * 0.10, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.arc(cx + r * 0.38, cy - r * 0.10, r * 0.10, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#0f172a'; ctx.beginPath(); ctx.arc(cx, cy + r * 0.14, r * 0.07, 0, Math.PI * 2); ctx.fill();
            ctx.strokeStyle = '#0f172a'; ctx.lineWidth = r * 0.06; ctx.lineCap = 'round';
            ctx.beginPath(); ctx.arc(cx, cy + r * 0.22, r * 0.22, 0.12 * Math.PI, 0.88 * Math.PI); ctx.stroke();
          });
        }

        function makeBunny(size = 900) {
          return animalBase(size, 'Conejito', 'üê∞', '#a78bfa', '#60a5fa', (ctx, S) => {
            const cx = S * 0.5, cy = S * 0.60, r = S * 0.20;
            ctx.fillStyle = 'rgba(0,0,0,.12)'; ctx.beginPath(); ctx.ellipse(cx, cy + r * 1.10, r * 0.95, r * 0.24, 0, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = 'rgba(255,255,255,.92)';
            ctx.beginPath(); ctx.ellipse(cx - r * 0.45, cy - r * 1.10, r * 0.28, r * 0.72, -0.15, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.ellipse(cx + r * 0.45, cy - r * 1.10, r * 0.28, r * 0.72, 0.15, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = 'rgba(251,113,133,.55)';
            ctx.beginPath(); ctx.ellipse(cx - r * 0.45, cy - r * 1.10, r * 0.16, r * 0.50, -0.15, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.ellipse(cx + r * 0.45, cy - r * 1.10, r * 0.16, r * 0.50, 0.15, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = 'rgba(255,255,255,.92)'; ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#0f172a';
            ctx.beginPath(); ctx.arc(cx - r * 0.35, cy - r * 0.10, r * 0.10, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.arc(cx + r * 0.35, cy - r * 0.10, r * 0.10, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#fb7185'; ctx.beginPath(); ctx.arc(cx, cy + r * 0.10, r * 0.07, 0, Math.PI * 2); ctx.fill();
            ctx.strokeStyle = '#0f172a'; ctx.lineWidth = r * 0.06; ctx.lineCap = 'round';
            ctx.beginPath(); ctx.arc(cx, cy + r * 0.15, r * 0.22, 0.15 * Math.PI, 0.85 * Math.PI); ctx.stroke();
          });
        }

        function makeLion(size = 900) {
          return animalBase(size, 'Le√≥n', 'ü¶Å', '#f59e0b', '#60a5fa', (ctx, S) => {
            const cx = S * 0.5, cy = S * 0.60, r = S * 0.18;
            ctx.fillStyle = 'rgba(0,0,0,.12)'; ctx.beginPath(); ctx.ellipse(cx, cy + r * 1.25, r * 1.05, r * 0.25, 0, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#f59e0b';
            for (let i = 0; i < 18; i++) {
              const a = i * (Math.PI * 2 / 18);
              ctx.beginPath();
              ctx.ellipse(cx + Math.cos(a) * r * 1.05, cy + Math.sin(a) * r * 1.05, r * 0.35, r * 0.20, a, 0, Math.PI * 2);
              ctx.fill();
            }
            ctx.fillStyle = '#fcd34d'; ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI * 2); ctx.fill();
            face(ctx, cx, cy, r * 0.65, '#fcd34d');
          });
        }

        function makeFrog(size = 900) {
          return animalBase(size, 'Rana', 'üê∏', '#22c55e', '#60a5fa', (ctx, S) => {
            const cx = S * 0.5, cy = S * 0.62, r = S * 0.20;
            ctx.fillStyle = 'rgba(0,0,0,.12)'; ctx.beginPath(); ctx.ellipse(cx, cy + r * 1.05, r * 1.05, r * 0.25, 0, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#22c55e'; ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#16a34a';
            ctx.beginPath(); ctx.arc(cx - r * 0.45, cy - r * 0.75, r * 0.35, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.arc(cx + r * 0.45, cy - r * 0.75, r * 0.35, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = 'rgba(255,255,255,.92)';
            ctx.beginPath(); ctx.arc(cx - r * 0.45, cy - r * 0.75, r * 0.20, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.arc(cx + r * 0.45, cy - r * 0.75, r * 0.20, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#0f172a';
            ctx.beginPath(); ctx.arc(cx - r * 0.45, cy - r * 0.75, r * 0.10, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.arc(cx + r * 0.45, cy - r * 0.75, r * 0.10, 0, Math.PI * 2); ctx.fill();
            ctx.strokeStyle = '#0f172a'; ctx.lineWidth = r * 0.06; ctx.lineCap = 'round';
            ctx.beginPath(); ctx.arc(cx, cy + r * 0.10, r * 0.55, 0.15 * Math.PI, 0.85 * Math.PI); ctx.stroke();
          });
        }

        function makeOwl(size = 900) {
          return animalBase(size, 'B√∫ho', 'ü¶â', '#1d4ed8', '#60a5fa', (ctx, S) => {
            const cx = S * 0.5, cy = S * 0.62, r = S * 0.20;
            ctx.fillStyle = 'rgba(0,0,0,.12)'; ctx.beginPath(); ctx.ellipse(cx, cy + r * 1.05, r * 1.00, r * 0.25, 0, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#a16207'; ctx.beginPath(); ctx.ellipse(cx, cy, r * 0.95, r * 1.05, 0, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = 'rgba(255,255,255,.92)';
            ctx.beginPath(); ctx.arc(cx - r * 0.35, cy - r * 0.15, r * 0.35, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.arc(cx + r * 0.35, cy - r * 0.15, r * 0.35, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#0f172a';
            ctx.beginPath(); ctx.arc(cx - r * 0.35, cy - r * 0.15, r * 0.14, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.arc(cx + r * 0.35, cy - r * 0.15, r * 0.14, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#f59e0b';
            ctx.beginPath();
            ctx.moveTo(cx, cy + r * 0.05);
            ctx.lineTo(cx - r * 0.10, cy + r * 0.30);
            ctx.lineTo(cx + r * 0.10, cy + r * 0.30);
            ctx.closePath(); ctx.fill();
          });
        }

        function makeWhale(size = 900) {
          return animalBase(size, 'Ballena', 'üê≥', '#60a5fa', '#22c55e', (ctx, S) => {
            const cx = S * 0.52, cy = S * 0.62;
            ctx.fillStyle = 'rgba(0,0,0,.10)'; ctx.beginPath(); ctx.ellipse(cx, cy + S * 0.20, S * 0.25, S * 0.06, 0, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#3b82f6';
            ctx.beginPath(); ctx.ellipse(cx, cy, S * 0.26, S * 0.14, 0, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = 'rgba(255,255,255,.85)';
            ctx.beginPath(); ctx.ellipse(cx + S * 0.02, cy + S * 0.03, S * 0.18, S * 0.09, 0, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#0f172a';
            ctx.beginPath(); ctx.arc(cx - S * 0.10, cy - S * 0.03, S * 0.014, 0, Math.PI * 2); ctx.fill();
            ctx.strokeStyle = '#0f172a'; ctx.lineWidth = S * 0.01; ctx.lineCap = 'round';
            ctx.beginPath(); ctx.arc(cx - S * 0.02, cy + S * 0.02, S * 0.06, 0.15 * Math.PI, 0.85 * Math.PI); ctx.stroke();
            ctx.fillStyle = 'rgba(255,255,255,.85)';
            ctx.beginPath(); ctx.ellipse(cx - S * 0.02, cy - S * 0.16, S * 0.02, S * 0.05, 0, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.ellipse(cx + S * 0.02, cy - S * 0.16, S * 0.02, S * 0.05, 0, 0, Math.PI * 2); ctx.fill();
          });
        }

        function makeTurtle(size = 900) {
          return animalBase(size, 'Tortuga', 'üê¢', '#34d399', '#60a5fa', (ctx, S) => {
            const cx = S * 0.5, cy = S * 0.64;
            ctx.fillStyle = '#16a34a';
            ctx.beginPath(); ctx.ellipse(cx, cy, S * 0.22, S * 0.14, 0, 0, Math.PI * 2); ctx.fill();
            ctx.strokeStyle = 'rgba(255,255,255,.35)'; ctx.lineWidth = S * 0.01;
            for (let i = -2; i <= 2; i++) {
              ctx.beginPath();
              ctx.ellipse(cx, cy, S * (0.20 - Math.abs(i) * 0.03), S * (0.12 - Math.abs(i) * 0.02), 0, 0, Math.PI * 2);
              ctx.stroke();
            }
            ctx.fillStyle = '#22c55e';
            ctx.beginPath(); ctx.ellipse(cx - S * 0.20, cy, S * 0.06, S * 0.05, 0, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#0f172a';
            ctx.beginPath(); ctx.arc(cx - S * 0.22, cy - S * 0.01, S * 0.010, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#22c55e';
            const pts = [[-0.10, 0.10], [0.05, 0.12], [0.05, -0.12], [-0.10, -0.10]];
            pts.forEach(([dx, dy]) => {
              ctx.beginPath(); ctx.ellipse(cx + S * dx, cy + S * dy, S * 0.05, S * 0.035, 0, 0, Math.PI * 2); ctx.fill();
            });
          });
        }

        function makeFox(size = 900) {
          return animalBase(size, 'Zorro', 'ü¶ä', '#f59e0b', '#a78bfa', (ctx, S) => {
            const cx = S * 0.5, cy = S * 0.62, r = S * 0.20;
            ctx.fillStyle = '#fb923c'; ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#f97316';
            ctx.beginPath(); ctx.moveTo(cx - r * 0.75, cy - r * 0.10); ctx.lineTo(cx - r * 1.00, cy - r * 0.95); ctx.lineTo(cx - r * 0.20, cy - r * 0.70); ctx.closePath(); ctx.fill();
            ctx.beginPath(); ctx.moveTo(cx + r * 0.75, cy - r * 0.10); ctx.lineTo(cx + r * 1.00, cy - r * 0.95); ctx.lineTo(cx + r * 0.20, cy - r * 0.70); ctx.closePath(); ctx.fill();
            ctx.fillStyle = 'rgba(255,255,255,.90)';
            ctx.beginPath(); ctx.ellipse(cx - r * 0.30, cy + r * 0.10, r * 0.45, r * 0.35, 0, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.ellipse(cx + r * 0.30, cy + r * 0.10, r * 0.45, r * 0.35, 0, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#0f172a';
            ctx.beginPath(); ctx.arc(cx - r * 0.30, cy - r * 0.05, r * 0.10, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.arc(cx + r * 0.30, cy - r * 0.05, r * 0.10, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.arc(cx, cy + r * 0.20, r * 0.07, 0, Math.PI * 2); ctx.fill();
          });
        }

        function makeKoala(size = 900) {
          return animalBase(size, 'Koala', 'üê®', '#60a5fa', '#94a3b8', (ctx, S) => {
            const cx = S * 0.5, cy = S * 0.62, r = S * 0.20;
            ctx.fillStyle = '#94a3b8';
            ctx.beginPath(); ctx.arc(cx - r * 0.75, cy - r * 0.55, r * 0.35, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.arc(cx + r * 0.75, cy - r * 0.55, r * 0.35, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#cbd5e1'; ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#0f172a';
            ctx.beginPath(); ctx.arc(cx - r * 0.30, cy - r * 0.05, r * 0.10, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.arc(cx + r * 0.30, cy - r * 0.05, r * 0.10, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#0f172a';
            ctx.beginPath(); ctx.ellipse(cx, cy + r * 0.12, r * 0.18, r * 0.22, 0, 0, Math.PI * 2); ctx.fill();
            ctx.strokeStyle = '#0f172a'; ctx.lineWidth = r * 0.06; ctx.lineCap = 'round';
            ctx.beginPath(); ctx.arc(cx, cy + r * 0.22, r * 0.22, 0.15 * Math.PI, 0.85 * Math.PI); ctx.stroke();
          });
        }

        /* ===== FRUTAS (10) ===== */
        function makeApple(size = 900) {
          return fruitBase(size, 'Manzana', 'üçé', '#60a5fa', '#22c55e', (ctx, S) => {
            const cx = S * 0.5, cy = S * 0.62, r = S * 0.20;
            ctx.fillStyle = 'rgba(0,0,0,.12)'; ctx.beginPath(); ctx.ellipse(cx, cy + r * 1.05, r * 0.95, r * 0.25, 0, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#ef4444';
            ctx.beginPath(); ctx.arc(cx - r * 0.55, cy, r, 0, Math.PI * 2); ctx.arc(cx + r * 0.55, cy, r, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = 'rgba(255,255,255,.25)';
            ctx.beginPath(); ctx.ellipse(cx - r * 0.55, cy - r * 0.15, r * 0.28, r * 0.50, -0.2, 0, Math.PI * 2); ctx.fill();
            ctx.strokeStyle = '#7c2d12'; ctx.lineWidth = S * 0.02; ctx.lineCap = 'round';
            ctx.beginPath(); ctx.moveTo(cx, cy - r * 1.15); ctx.quadraticCurveTo(cx + r * 0.08, cy - r * 1.55, cx + r * 0.12, cy - r * 1.80); ctx.stroke();
            ctx.fillStyle = '#22c55e';
            ctx.beginPath(); ctx.ellipse(cx + r * 0.45, cy - r * 1.35, r * 0.50, r * 0.25, -0.5, 0, Math.PI * 2); ctx.fill();
            face(ctx, cx, cy + r * 0.10, r * 0.62, '#ef4444');
          });
        }

        function makeBanana(size = 900) {
          return fruitBase(size, 'Pl√°tano', 'üçå', '#a78bfa', '#60a5fa', (ctx, S) => {
            const cx = S * 0.52, cy = S * 0.62;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#facc15'; ctx.lineWidth = S * 0.14;
            ctx.beginPath(); ctx.arc(cx, cy, S * 0.26, 1.10 * Math.PI, 1.90 * Math.PI); ctx.stroke();
            ctx.strokeStyle = 'rgba(15,23,42,.10)'; ctx.lineWidth = S * 0.015;
            ctx.beginPath(); ctx.arc(cx, cy, S * 0.26, 1.10 * Math.PI, 1.90 * Math.PI); ctx.stroke();
            face(ctx, S * 0.48, S * 0.60, S * 0.10, '#facc15');
          });
        }

        function makeGrape(size = 900) {
          return fruitBase(size, 'Uva', 'üçá', '#60a5fa', '#a78bfa', (ctx, S) => {
            const cx = S * 0.52, cy = S * 0.62;
            ctx.fillStyle = 'rgba(0,0,0,.12)'; ctx.beginPath(); ctx.ellipse(cx, cy + S * 0.22, S * 0.24, S * 0.06, 0, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#8b5cf6';
            const pts = [[0, 0], [-0.12, -0.02], [0.12, -0.02], [-0.06, 0.11], [0.06, 0.11], [0, 0.22]];
            pts.forEach(([dx, dy]) => {
              ctx.beginPath(); ctx.arc(cx + S * dx, cy + S * dy, S * 0.08, 0, Math.PI * 2); ctx.fill();
            });
            ctx.fillStyle = '#22c55e';
            ctx.beginPath(); ctx.ellipse(cx + S * 0.08, cy - S * 0.16, S * 0.10, S * 0.05, -0.4, 0, Math.PI * 2); ctx.fill();
            face(ctx, cx, cy + S * 0.03, S * 0.08, '#8b5cf6');
          });
        }

        function makeOrange(size = 900) {
          return fruitBase(size, 'Naranja', 'üçä', '#f59e0b', '#60a5fa', (ctx, S) => {
            const cx = S * 0.5, cy = S * 0.62, r = S * 0.20;
            ctx.fillStyle = '#fb923c'; ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = 'rgba(255,255,255,.18)'; ctx.beginPath(); ctx.ellipse(cx - r * 0.20, cy - r * 0.10, r * 0.22, r * 0.40, -0.4, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#22c55e'; ctx.beginPath(); ctx.ellipse(cx + r * 0.35, cy - r * 0.75, r * 0.40, r * 0.20, -0.5, 0, Math.PI * 2); ctx.fill();
            face(ctx, cx, cy + r * 0.05, r * 0.62, '#fb923c');
          });
        }

        function makeStrawberry(size = 900) {
          return fruitBase(size, 'Fresa', 'üçì', '#60a5fa', '#fb7185', (ctx, S) => {
            const cx = S * 0.5, cy = S * 0.62, r = S * 0.20;
            ctx.fillStyle = '#ef4444';
            ctx.beginPath();
            ctx.moveTo(cx, cy + r * 1.10);
            ctx.quadraticCurveTo(cx - r * 1.10, cy + r * 0.10, cx, cy - r * 0.95);
            ctx.quadraticCurveTo(cx + r * 1.10, cy + r * 0.10, cx, cy + r * 1.10);
            ctx.closePath(); ctx.fill();
            ctx.fillStyle = 'rgba(255,255,255,.75)';
            for (let i = 0; i < 18; i++) {
              const x = cx + (Math.random() * 2 - 1) * r * 0.65;
              const y = cy + (Math.random() * 2 - 1) * r * 0.75;
              ctx.beginPath(); ctx.ellipse(x, y, r * 0.05, r * 0.03, Math.random(), 0, Math.PI * 2); ctx.fill();
            }
            ctx.fillStyle = '#22c55e';
            for (let i = 0; i < 5; i++) {
              const a = (i - 2) * 0.35;
              ctx.beginPath();
              ctx.ellipse(cx + Math.sin(a) * r * 0.45, cy - r * 1.00, r * 0.35, r * 0.16, a, 0, Math.PI * 2);
              ctx.fill();
            }
            face(ctx, cx, cy + r * 0.10, r * 0.55, '#ef4444');
          });
        }

        function makeWatermelon(size = 900) {
          return fruitBase(size, 'Sand√≠a', 'üçâ', '#22c55e', '#60a5fa', (ctx, S) => {
            const cx = S * 0.5, cy = S * 0.68, r = S * 0.22;
            ctx.fillStyle = '#16a34a';
            ctx.beginPath(); ctx.arc(cx, cy, r, Math.PI, 2 * Math.PI); ctx.fill();
            ctx.fillStyle = '#ef4444';
            ctx.beginPath(); ctx.arc(cx, cy, r * 0.85, Math.PI, 2 * Math.PI); ctx.fill();
            ctx.strokeStyle = 'rgba(255,255,255,.80)'; ctx.lineWidth = r * 0.12;
            ctx.beginPath(); ctx.arc(cx, cy, r * 0.92, Math.PI, 2 * Math.PI); ctx.stroke();
            ctx.fillStyle = 'rgba(15,23,42,.75)';
            for (let i = 0; i < 9; i++) {
              const a = Math.PI + (i + 1) * Math.PI / 10;
              const x = cx + Math.cos(a) * r * 0.55;
              const y = cy + Math.sin(a) * r * 0.55;
              ctx.beginPath(); ctx.ellipse(x, y, r * 0.06, r * 0.03, a, 0, Math.PI * 2); ctx.fill();
            }
            face(ctx, cx, cy - r * 0.20, r * 0.45, '#ef4444');
          });
        }

        function makePear(size = 900) {
          return fruitBase(size, 'Pera', 'üçê', '#60a5fa', '#22c55e', (ctx, S) => {
            const cx = S * 0.5, cy = S * 0.64, r = S * 0.18;
            ctx.fillStyle = '#a3e635';
            ctx.beginPath();
            ctx.ellipse(cx, cy + r * 0.60, r * 1.15, r * 1.05, 0, 0, Math.PI * 2);
            ctx.ellipse(cx, cy - r * 0.55, r * 0.75, r * 0.75, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#7c2d12'; ctx.lineWidth = S * 0.02; ctx.lineCap = 'round';
            ctx.beginPath(); ctx.moveTo(cx, cy - r * 1.35); ctx.quadraticCurveTo(cx + r * 0.10, cy - r * 1.65, cx + r * 0.15, cy - r * 1.85); ctx.stroke();
            ctx.fillStyle = '#22c55e'; ctx.beginPath(); ctx.ellipse(cx + r * 0.40, cy - r * 1.45, r * 0.50, r * 0.25, -0.5, 0, Math.PI * 2); ctx.fill();
            face(ctx, cx, cy + r * 0.25, r * 0.55, '#a3e635');
          });
        }

        function makeLemon(size = 900) {
          return fruitBase(size, 'Lim√≥n', 'üçã', '#60a5fa', '#facc15', (ctx, S) => {
            const cx = S * 0.5, cy = S * 0.62, r = S * 0.20;
            ctx.fillStyle = '#fde047';
            ctx.beginPath(); ctx.ellipse(cx, cy, r * 1.25, r, 0, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = 'rgba(15,23,42,.08)';
            ctx.beginPath(); ctx.ellipse(cx - r * 1.22, cy, r * 0.18, r * 0.12, 0, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.ellipse(cx + r * 1.22, cy, r * 0.18, r * 0.12, 0, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = 'rgba(255,255,255,.22)';
            ctx.beginPath(); ctx.ellipse(cx - r * 0.30, cy - r * 0.15, r * 0.28, r * 0.55, -0.5, 0, Math.PI * 2); ctx.fill();
            face(ctx, cx, cy + r * 0.05, r * 0.60, '#fde047');
          });
        }

        function makePeach(size = 900) {
          return fruitBase(size, 'Durazno', 'üçë', '#fb7185', '#60a5fa', (ctx, S) => {
            const cx = S * 0.5, cy = S * 0.64, r = S * 0.20;
            ctx.fillStyle = '#fb7185';
            ctx.beginPath(); ctx.arc(cx - r * 0.50, cy, r, 0, Math.PI * 2); ctx.arc(cx + r * 0.50, cy, r, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = 'rgba(255,255,255,.18)';
            ctx.beginPath(); ctx.ellipse(cx - r * 0.55, cy - r * 0.10, r * 0.25, r * 0.45, -0.4, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#22c55e'; ctx.beginPath(); ctx.ellipse(cx + r * 0.35, cy - r * 1.15, r * 0.55, r * 0.18, -0.5, 0, Math.PI * 2); ctx.fill();
            face(ctx, cx, cy + r * 0.10, r * 0.60, '#fb7185');
          });
        }

        function makePineapple(size = 900) {
          return fruitBase(size, 'Pi√±a', 'üçç', '#f59e0b', '#22c55e', (ctx, S) => {
            const cx = S * 0.5, cy = S * 0.68, r = S * 0.16;
            ctx.fillStyle = '#fbbf24';
            ctx.beginPath(); ctx.ellipse(cx, cy, r * 1.25, r * 1.65, 0, 0, Math.PI * 2); ctx.fill();
            ctx.strokeStyle = 'rgba(15,23,42,.10)'; ctx.lineWidth = S * 0.01;
            for (let i = -4; i <= 4; i++) {
              ctx.beginPath(); ctx.moveTo(cx - r * 1.0, cy + i * r * 0.35);
              ctx.lineTo(cx + r * 1.0, cy + i * r * 0.35);
              ctx.stroke();
            }
            ctx.fillStyle = '#22c55e';
            for (let i = -2; i <= 2; i++) {
              ctx.beginPath();
              ctx.ellipse(cx + i * r * 0.35, cy - r * 2.0, r * 0.30, r * 1.10, i * 0.15, 0, Math.PI * 2);
              ctx.fill();
            }
            face(ctx, cx, cy + r * 0.10, r * 0.55, '#fbbf24');
          });
        }

        /* ============================
           ‚úÖ Base items
        ============================ */
        const baseItems = [
          { id: 'demo_rainbow', title: 'Arco√≠ris', tag: 'Demo', type: 'demo', make: makeRainbowDemo },

          { id: 'animal_cat', title: 'Gatito', tag: 'Animal', type: 'animal', make: makeCat },
          { id: 'animal_panda', title: 'Panda', tag: 'Animal', type: 'animal', make: makePanda },
          { id: 'animal_bunny', title: 'Conejito', tag: 'Animal', type: 'animal', make: makeBunny },
          { id: 'animal_lion', title: 'Le√≥n', tag: 'Animal', type: 'animal', make: makeLion },
          { id: 'animal_frog', title: 'Rana', tag: 'Animal', type: 'animal', make: makeFrog },
          { id: 'animal_owl', title: 'B√∫ho', tag: 'Animal', type: 'animal', make: makeOwl },
          { id: 'animal_whale', title: 'Ballena', tag: 'Animal', type: 'animal', make: makeWhale },
          { id: 'animal_turtle', title: 'Tortuga', tag: 'Animal', type: 'animal', make: makeTurtle },
          { id: 'animal_fox', title: 'Zorro', tag: 'Animal', type: 'animal', make: makeFox },
          { id: 'animal_koala', title: 'Koala', tag: 'Animal', type: 'animal', make: makeKoala },

          { id: 'fruit_apple', title: 'Manzana', tag: 'Fruta', type: 'fruit', make: makeApple },
          { id: 'fruit_banana', title: 'Pl√°tano', tag: 'Fruta', type: 'fruit', make: makeBanana },
          { id: 'fruit_grape', title: 'Uva', tag: 'Fruta', type: 'fruit', make: makeGrape },
          { id: 'fruit_orange', title: 'Naranja', tag: 'Fruta', type: 'fruit', make: makeOrange },
          { id: 'fruit_strawberry', title: 'Fresa', tag: 'Fruta', type: 'fruit', make: makeStrawberry },
          { id: 'fruit_watermelon', title: 'Sand√≠a', tag: 'Fruta', type: 'fruit', make: makeWatermelon },
          { id: 'fruit_pear', title: 'Pera', tag: 'Fruta', type: 'fruit', make: makePear },
          { id: 'fruit_lemon', title: 'Lim√≥n', tag: 'Fruta', type: 'fruit', make: makeLemon },
          { id: 'fruit_peach', title: 'Durazno', tag: 'Fruta', type: 'fruit', make: makePeach },
          { id: 'fruit_pineapple', title: 'Pi√±a', tag: 'Fruta', type: 'fruit', make: makePineapple },
        ];

        const generated = baseItems.map(it => ({ ...it, url: it.make() }));

        // Cargar ‚ÄúMis im√°genes‚Äù guardadas
        const savedCustom = lsGet(LS.custom, []);
        const customItems = Array.isArray(savedCustom) ? savedCustom : [];

        let items = [...generated, ...customItems];

        /* ============================
           ‚úÖ DOM
        ============================ */
        const boardEl = document.getElementById('board');
        const trayGrid = document.getElementById('trayGrid');
        const previewEl = document.getElementById('preview');
        const galleryEl = document.getElementById('gallery');
        const imgSelect = document.getElementById('imgSelect');

        const doneEl = document.getElementById('done');
        const totalEl = document.getElementById('total');
        const timeEl = document.getElementById('time');
        const movesEl = document.getElementById('moves');

        const levelSel = document.getElementById('level');
        const fileInput = document.getElementById('file');
        const soundToggle = document.getElementById('sound');
        const catFilter = document.getElementById('catFilter');

        const winOverlay = document.getElementById('winOverlay');
        const winTime = document.getElementById('winTime');
        const winMoves = document.getElementById('winMoves');
        const winLevel = document.getElementById('winLevel');

        /* ============================
           ‚úÖ Load saved
        ============================ */
        const savedLevel = lsGet(LS.level, 3);
        const savedSound = lsGet(LS.sound, true);
        const savedPreview = lsGet(LS.preview, true);
        const savedCat = lsGet(LS.cat, 'all');
        const savedActiveId = lsGet(LS.activeId, 'demo_rainbow');

        levelSel.value = String(savedLevel);
        soundToggle.checked = !!savedSound;
        previewEl.style.display = savedPreview ? 'block' : 'none';
        catFilter.value = savedCat;

        let activeId = items.some(x => x.id === savedActiveId) ? savedActiveId : 'demo_rainbow';
        let imgURL = items.find(x => x.id === activeId)?.url || items[0].url;

        /* ============================
           ‚úÖ Game state
        ============================ */
        let N = parseInt(levelSel.value, 10);
        let pieces = [];
        let placedCount = 0;
        let moves = 0;

        let seconds = 0;
        let timer = null;

        let dragging = null;
        let pointerId = null;

        function pad2(x) { return String(x).padStart(2, '0'); }
        function fmtTime(s) {
          const m = Math.floor(s / 60), r = s % 60;
          return `${pad2(m)}:${pad2(r)}`;
        }
        function startTimer() {
          stopTimer();
          timer = setInterval(() => {
            seconds++;
            timeEl.textContent = fmtTime(seconds);
          }, 1000);
        }
        function stopTimer() {
          if (timer) { clearInterval(timer); timer = null; }
        }

        /* ============================
           ‚úÖ Confetti
        ============================ */
        function confettiBurst() {
          const box = document.getElementById('confetti');
          box.innerHTML = '';
          const colors = ['#22c55e', '#3b82f6', '#f59e0b', '#ef4444', '#a78bfa', '#06b6d4', '#f472b6'];
          const count = 90;
          for (let i = 0; i < count; i++) {
            const d = document.createElement('div');
            d.className = 'conf';
            d.style.left = (Math.random() * 100) + '%';
            d.style.top = (-10 - Math.random() * 30) + 'px';
            d.style.background = colors[(Math.random() * colors.length) | 0];
            d.style.animationDuration = (1.0 + Math.random() * 0.9) + 's';
            d.style.width = (8 + Math.random() * 10) + 'px';
            d.style.height = (10 + Math.random() * 16) + 'px';
            box.appendChild(d);
          }
        }

        /* ============================
           ‚úÖ Persist
        ============================ */
        function persistState() {
          lsSet(LS.activeId, activeId);
          lsSet(LS.level, parseInt(levelSel.value, 10));
          lsSet(LS.sound, !!soundToggle.checked);
          lsSet(LS.preview, previewEl.style.display !== 'none');
          lsSet(LS.cat, catFilter.value);
        }

        function saveCustomItems() {
          const onlyCustom = items.filter(x => x.type === 'custom').map(x => ({
            id: x.id, title: x.title, tag: x.tag, url: x.url, type: 'custom'
          }));
          lsSet(LS.custom, onlyCustom);
        }

        /* ============================
           ‚úÖ Audio
        ============================ */
        let audioCtx = null;
        function beep(type = 'good') {
          if (!soundToggle.checked) return;
          if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          const t = audioCtx.currentTime;
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          o.connect(g); g.connect(audioCtx.destination);

          o.type = 'sine';
          o.frequency.value = (type === 'win') ? 660 : (type === 'good' ? 520 : 220);
          g.gain.setValueAtTime(0.0001, t);
          g.gain.exponentialRampToValueAtTime(0.12, t + 0.01);
          g.gain.exponentialRampToValueAtTime(0.0001, t + 0.18);
          o.start(t);
          o.stop(t + 0.20);
        }

        /* ============================
           ‚úÖ Filtered items by category
        ============================ */
        function filteredItems() {
          const cat = catFilter.value;
          return items.filter(it => (cat === 'all') ? true : (it.type === cat));
        }

        /* ============================
           ‚úÖ Render select options (dropdown)
        ============================ */
        function renderSelect() {
          const list = filteredItems();

          imgSelect.innerHTML = '';
          const opt0 = document.createElement('option');
          opt0.value = '';
          opt0.textContent = 'Seleccionar imagen‚Ä¶';
          imgSelect.appendChild(opt0);

          list.forEach(it => {
            const opt = document.createElement('option');
            opt.value = it.id;
            opt.textContent = `${it.title} (${it.tag})`;
            if (it.id === activeId) opt.selected = true;
            imgSelect.appendChild(opt);
          });

          // Si el activeId no est√° en la categor√≠a, lo dejamos en placeholder
          if (!list.some(x => x.id === activeId)) imgSelect.value = '';
        }

        /* ============================
           ‚úÖ Render gallery thumbnails
        ============================ */
        function renderGallery() {
          galleryEl.innerHTML = '';
          const list = filteredItems();

          if (!list.length) {
            const empty = document.createElement('div');
            empty.className = 'smallMuted';
            empty.textContent = 'No hay im√°genes en esta categor√≠a.';
            galleryEl.appendChild(empty);
            return;
          }

          list.forEach(item => {
            const t = document.createElement('div');
            t.className = 'thumb' + (item.id === activeId ? ' active' : '');
            t.title = item.title;

            const img = document.createElement('div');
            img.className = 'img';
            img.style.backgroundImage = `url("${item.url}")`;

            const tag = document.createElement('div');
            tag.className = 'tag';
            tag.textContent = item.tag;

            t.appendChild(img);
            t.appendChild(tag);

            t.addEventListener('click', () => {
              activeId = item.id;
              imgURL = item.url;
              persistState();
              renderSelect();
              renderGallery();
              build();
            });

            galleryEl.appendChild(t);
          });
        }

        /* ============================
           ‚úÖ Puzzle build
        ============================ */
        function setGrid(n) {
          N = n;
          boardEl.style.gridTemplateColumns = `repeat(${N}, 1fr)`;
          boardEl.style.gridTemplateRows = `repeat(${N}, 1fr)`;
        }

        function makePieceBG(r, c) {
          const sizePct = N * 100;
          const x = (c / (N - 1)) * 100;
          const y = (r / (N - 1)) * 100;
          return {
            backgroundImage: `url("${imgURL}")`,
            backgroundSize: `${sizePct}% ${sizePct}%`,
            backgroundPosition: `${x}% ${y}%`,
          };
        }

        function clearAll() {
          boardEl.innerHTML = '';
          trayGrid.innerHTML = '';
          pieces = [];
          placedCount = 0;
          moves = 0;
          seconds = 0;
          doneEl.textContent = '0';
          movesEl.textContent = '0';
          timeEl.textContent = '00:00';
          stopTimer();
        }

        function shuffleTray() {
          const nodes = Array.from(trayGrid.children);
          for (let i = nodes.length - 1; i > 0; i--) {
            const j = (Math.random() * (i + 1)) | 0;
            trayGrid.insertBefore(nodes[j], nodes[i]);
            nodes.splice(j, 1);
          }
        }

        function build() {
          clearAll();
          setGrid(parseInt(levelSel.value, 10));
          previewEl.style.backgroundImage = `url("${imgURL}")`;

          const total = N * N;
          totalEl.textContent = String(total);

          for (let r = 0; r < N; r++) {
            for (let c = 0; c < N; c++) {
              const slot = document.createElement('div');
              slot.className = 'slot';
              slot.dataset.slot = `${r}-${c}`;
              boardEl.appendChild(slot);
            }
          }

          for (let r = 0; r < N; r++) {
            for (let c = 0; c < N; c++) {
              const p = document.createElement('div');
              p.className = 'piece';
              p.dataset.piece = `${r}-${c}`;
              Object.assign(p.style, makePieceBG(r, c));
              trayGrid.appendChild(p);
              pieces.push({ id: `${r}-${c}`, r, c, el: p, placed: false });
            }
          }

          shuffleTray();
          attachDragHandlers();
          startTimer();
        }

        /* ============================
           ‚úÖ Drag & Drop (Pointer)
        ============================ */
        function attachDragHandlers() {
          pieces.forEach(p => p.el.addEventListener('pointerdown', onPointerDown, { passive: false }));
          window.addEventListener('pointermove', onPointerMove, { passive: false });
          window.addEventListener('pointerup', onPointerUp, { passive: false });
          window.addEventListener('pointercancel', onPointerUp, { passive: false });
        }

        function onPointerDown(e) {
          const el = e.currentTarget;
          const pieceObj = pieces.find(x => x.el === el);
          if (!pieceObj || pieceObj.placed) return;

          e.preventDefault();
          el.setPointerCapture(e.pointerId);
          pointerId = e.pointerId;

          const rect = el.getBoundingClientRect();
          dragging = {
            piece: pieceObj,
            offsetX: e.clientX - rect.left,
            offsetY: e.clientY - rect.top,
            origParent: el.parentElement,
            origNext: el.nextSibling
          };

          el.classList.add('dragging');
          el.style.position = 'fixed';
          el.style.left = (e.clientX - dragging.offsetX) + 'px';
          el.style.top = (e.clientY - dragging.offsetY) + 'px';
          el.style.width = rect.width + 'px';
          el.style.height = rect.height + 'px';
          el.style.margin = '0';
        }

        function onPointerMove(e) {
          if (!dragging || e.pointerId !== pointerId) return;
          e.preventDefault();

          const el = dragging.piece.el;
          el.style.left = (e.clientX - dragging.offsetX) + 'px';
          el.style.top = (e.clientY - dragging.offsetY) + 'px';

          highlightClosestSlot(e.clientX, e.clientY);
        }

        function onPointerUp(e) {
          if (!dragging || e.pointerId !== pointerId) return;
          e.preventDefault();

          const { piece } = dragging;
          const snap = findSnapSlot(e.clientX, e.clientY);

          if (snap) {
            placePiece(piece, snap.slotEl);
            beep('good');
          } else {
            resetFloating(piece.el);
            dragging.origParent.insertBefore(piece.el, dragging.origNext);
          }

          clearSlotHighlight();
          dragging = null;
          pointerId = null;
        }

        function resetFloating(el) {
          el.classList.remove('dragging');
          el.style.position = '';
          el.style.left = '';
          el.style.top = '';
          el.style.width = '';
          el.style.height = '';
        }

        function boardSlots() {
          return Array.from(boardEl.querySelectorAll('.slot'));
        }

        function findSnapSlot(x, y) {
          const slots = boardSlots();
          let best = null;
          for (const s of slots) {
            if (s.querySelector('.piece')) continue;
            const r = s.getBoundingClientRect();
            const cx = r.left + r.width / 2;
            const cy = r.top + r.height / 2;
            const d = Math.hypot(x - cx, y - cy);
            if (!best || d < best.d) best = { d, slotEl: s, rect: r };
          }
          if (!best) return null;
          const threshold = Math.min(best.rect.width, best.rect.height) * 0.55;
          return (best.d <= threshold) ? best : null;
        }

        function highlightClosestSlot(x, y) {
          const slots = boardSlots();
          let best = null;
          for (const s of slots) {
            if (s.querySelector('.piece')) continue;
            const r = s.getBoundingClientRect();
            const cx = r.left + r.width / 2;
            const cy = r.top + r.height / 2;
            const d = Math.hypot(x - cx, y - cy);
            if (!best || d < best.d) best = { d, slotEl: s, rect: r };
          }
          clearSlotHighlight();
          if (!best) return;
          const threshold = Math.min(best.rect.width, best.rect.height) * 0.65;
          if (best.d <= threshold) best.slotEl.classList.add('hint');
        }

        function clearSlotHighlight() {
          boardSlots().forEach(s => s.classList.remove('hint'));
        }

        function placePiece(piece, slotEl) {
          const target = slotEl.dataset.slot;
          const id = piece.id;

          resetFloating(piece.el);

          moves++;
          movesEl.textContent = String(moves);

          if (id === target) {
            piece.placed = true;
            slotEl.classList.add('good');

            piece.el.classList.add('placed');
            piece.el.style.width = '100%';
            piece.el.style.height = '100%';
            piece.el.style.borderRadius = '12px';

            slotEl.appendChild(piece.el);
            placedCount++;
            doneEl.textContent = String(placedCount);

            if (placedCount === N * N) onWin();
          } else {
            if (navigator.vibrate) navigator.vibrate(40);
            beep('bad');
            trayGrid.appendChild(piece.el);
          }
        }

        function onWin() {
          stopTimer();
          beep('win');
          confettiBurst();

          winTime.textContent = fmtTime(seconds);
          winMoves.textContent = String(moves);
          winLevel.textContent = `${N}x${N}`;

          winOverlay.style.display = 'flex';
        }

        /* ============================
           ‚úÖ Hints / Auto
        ============================ */
        function showHint() {
          const remaining = pieces.filter(p => !p.placed);
          if (!remaining.length) return;
          const p = remaining[(Math.random() * remaining.length) | 0];
          const slot = boardEl.querySelector(`.slot[data-slot="${p.id}"]`);
          if (!slot) return;
          slot.classList.add('hint');
          setTimeout(() => slot.classList.remove('hint'), 1200);
        }

        function autoPlaceOne() {
          const remaining = pieces.filter(p => !p.placed);
          if (!remaining.length) return;

          let p = remaining[(Math.random() * remaining.length) | 0];
          let slot = boardEl.querySelector(`.slot[data-slot="${p.id}"]`);
          if (!slot) return;

          if (slot.querySelector('.piece')) {
            const alt = remaining.find(x => {
              const s = boardEl.querySelector(`.slot[data-slot="${x.id}"]`);
              return s && !s.querySelector('.piece');
            });
            if (!alt) return;
            p = alt;
            slot = boardEl.querySelector(`.slot[data-slot="${p.id}"]`);
            if (!slot) return;
          }
          placePiece(p, slot);
        }

        function markAllSlots(ms = 3000) {
          boardSlots().forEach(slot => slot.classList.add('hint'));
          setTimeout(() => boardSlots().forEach(slot => slot.classList.remove('hint')), ms);
        }

        /* ============================
           ‚úÖ Upload custom images
        ============================ */
        fileInput.addEventListener('change', (e) => {
          const f = e.target.files?.[0];
          if (!f) return;

          const reader = new FileReader();
          reader.onload = () => {
            const url = String(reader.result);
            const newId = 'custom_' + Date.now();
            const newItem = { id: newId, title: 'Mi imagen', tag: 'Mi foto', type: 'custom', url };

            items = [newItem, ...items];
            activeId = newId;
            imgURL = url;

            catFilter.value = 'custom';
            persistState();
            saveCustomItems();
            renderSelect();
            renderGallery();
            build();
          };
          reader.readAsDataURL(f);
        });

        /* ============================
           ‚úÖ Controls
        ============================ */
        document.getElementById('btnNew').addEventListener('click', build);
        document.getElementById('btnShuffle').addEventListener('click', shuffleTray);
        document.getElementById('btnHint').addEventListener('click', showHint);
        document.getElementById('btnAuto').addEventListener('click', autoPlaceOne);

        document.getElementById('btnResetTime').addEventListener('click', () => {
          seconds = 0; timeEl.textContent = '00:00';
        });
        document.getElementById('btnShowAllHints').addEventListener('click', () => markAllSlots(3000));
        document.getElementById('btnHideHints').addEventListener('click', () => boardSlots().forEach(s => s.classList.remove('hint')));

        document.getElementById('btnTogglePreview').addEventListener('click', () => {
          const shown = previewEl.style.display !== 'none';
          previewEl.style.display = shown ? 'none' : 'block';
          persistState();
        });

        document.getElementById('btnClearGallery').addEventListener('click', () => {
          items = items.filter(x => x.type !== 'custom');
          lsSet(LS.custom, []);
          if (activeId.startsWith('custom_')) {
            activeId = 'demo_rainbow';
            imgURL = items.find(x => x.id === activeId)?.url || items[0].url;
            persistState();
          }
          renderSelect();
          renderGallery();
          build();
        });

        document.getElementById('btnResetAll').addEventListener('click', () => {
          Object.values(LS).forEach(lsDel);
          location.reload();
        });

        levelSel.addEventListener('change', () => { persistState(); build(); });
        soundToggle.addEventListener('change', persistState);

        catFilter.addEventListener('change', () => {
          persistState();
          renderSelect();
          renderGallery();
        });

        // ‚úÖ Al escoger imagen en el desplegable
        imgSelect.addEventListener('change', () => {
          const id = imgSelect.value;
          if (!id) return;
          const item = items.find(x => x.id === id);
          if (!item) return;
          activeId = id;
          imgURL = item.url;
          persistState();
          renderGallery();
          build();
        });

        // Modal ganador
        document.getElementById('btnCloseWin').addEventListener('click', () => winOverlay.style.display = 'none');
        document.getElementById('btnAgain').addEventListener('click', () => { winOverlay.style.display = 'none'; build(); });
        document.getElementById('btnNext').addEventListener('click', () => {
          winOverlay.style.display = 'none';
          const v = parseInt(levelSel.value, 10);
          if (v < 4) levelSel.value = String(v + 1);
          persistState();
          build();
        });

        /* ============================
           ‚úÖ Init
        ============================ */
        // Pintar imagen inicial
        previewEl.style.backgroundImage = `url("${imgURL}")`;

        renderSelect();
        renderGallery();
        build();
      })();
    </script>

    <script>
      // Registrar Service Worker (PWA)
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("./service-worker.js").catch(() => { });
        });
      }
    </script>
  </body>

</html>
